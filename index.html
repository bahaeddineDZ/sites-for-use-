<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>📚 مكتبتي للمواقع - Baha</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --primary:#2c3e50;
  --accent:#2980b9;
  --danger:#e74c3c;
  --muted:#7f8c8d;
  --card:#ffffff;
  --font-size:16px;
}
*{box-sizing:border-box;}
body{font-family:Tahoma, Arial, sans-serif;margin:0;padding:0;min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(180deg,#eef6fb,#f4f6f9);font-size:var(--font-size);}
header{background:var(--primary);color:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
header h1{margin:0;font-size:18px;}
.user-area{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.user-pic{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.2);}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid rgba(0,0,0,0.06);}
.layout{display:flex;gap:18px;padding:18px;flex:1;align-items:flex-start;flex-wrap:wrap;}
.board{flex:1;min-width:320px;position:relative;}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
.controls input{padding:10px;border-radius:10px;border:1px solid #d0d7de;font-size:14px;flex:1;min-width:140px;}
.controls .add-btn,.controls .bg-btn,.controls .page-btn,.controls .font-btn{padding:10px 16px;border-radius:10px;border:none;cursor:pointer;}
.controls .add-btn{background:var(--accent);color:#fff;}
.controls .bg-btn{background:#2ecc71;color:#fff;}
.controls .page-btn{background:#8e44ad;color:#fff;}
.controls .font-btn{background:#e67e22;color:#fff;}
#siteList{position:relative;min-height:420px;border-radius:12px;padding:12px;background:transparent;resize:both;overflow:auto;}
.card{position:absolute;width:200px;height:250px;border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,0.12);overflow:hidden;background:var(--card);transition:transform .15s;}
.card:hover{transform:translateY(-6px);}
.card img{width:100%;height:100%;object-fit:cover;display:block;cursor:pointer;}
.card-content{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);color:#fff;padding:8px;text-align:center;}
.card-content h3{margin:0;font-size:14px;}
.card .drag-handle{position:absolute;top:6px;right:6px;width:22px;height:22px;background:var(--accent);border-radius:6px;cursor:move;}
.card .resize-handle{position:absolute;left:6px;bottom:6px;width:16px;height:16px;background:#2ecc71;clip-path:polygon(0 100%,100% 100%,0 0);cursor:nwse-resize;}
.card .actions button{margin:2px;padding:6px 8px;border-radius:8px;border:none;cursor:pointer;}
.card .actions .delete{background:var(--danger);color:#fff;}
.card .actions .edit{background:#f39c12;color:#fff;}
.side{width:360px;max-width:40vw;display:flex;flex-direction:column;gap:12px;}
.list-panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.06);min-height:180px;resize:vertical;overflow:auto;}
.list-panel h3{margin:0 0 8px 0;font-size:16px;color:var(--primary);}
.sites-list-short{display:flex;flex-direction:column;gap:8px;max-height:160px;overflow:auto;}
.site-item{display:flex;gap:8px;align-items:center;}
.site-item img{width:48px;height:36px;object-fit:cover;border-radius:6px;}
.site-item a{color:var(--accent);text-decoration:none;display:block;}
.chat-panel{display:flex;flex-direction:column;gap:8px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.06);position:relative;resize:vertical;overflow:auto;}
#chatBox{height:260px;overflow:auto;border-radius:8px;padding:8px;background:#fbfdff;border:1px solid #eef5fb;}
.msg{display:inline-block;padding:8px 12px;margin:5px 0;border-radius:15px;max-width:70%;clear:both;word-wrap:break-word;}
.chat-controls{display:flex;gap:5px;margin-top:6px;position:relative;}
.chat-controls input{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;}
.chat-controls button{padding:8px 12px;border:none;border-radius:6px;background:#2980b9;color:white;cursor:pointer;}
.chat-controls button:hover{background:#1f5f87;}
.emoji-panel{display:none;background:white;border:1px solid #ccc;border-radius:10px;padding:10px;max-height:120px;overflow-y:auto;position:absolute;bottom:60px;right:10px;z-index:1000;box-shadow:0 6px 12px rgba(0,0,0,0.15);transition:all 0.2s ease;}
.emoji-panel span{cursor:pointer;font-size:20px;margin:5px;}
#chatHint{margin-top:8px;font-size:12px;color:gray;text-align:center;}
footer{padding:10px;text-align:center;color:var(--muted);font-size:13px;}
@media(max-width:900px){.layout{flex-direction:column}.side{width:100%;}}
</style>
</head>
<body>

<header>
<h1>📚 مكتبتي للمواقع - Baha</h1>
<div class="user-area" id="userArea">
<img id="userPic" class="user-pic" src="" alt="" style="display:none">
<div id="userName" class="small" style="display:none"></div>
<button id="loginBtn" class="btn">🔑 تسجيل الدخول</button>
<button id="logoutBtn" class="btn secondary" style="display:none">تسجيل الخروج</button>
</div>
</header>

<div class="layout">
<div class="board">
<div class="controls">
<input id="siteName" placeholder="اسم الموقع">
<input id="siteUrl" placeholder="رابط الموقع (https://)">
<input id="siteImage" placeholder="رابط صورة (اختياري)">
<button id="addBtn" class="add-btn">➕ إضافة</button>
<button id="changeBgBtn" class="bg-btn">🎨 تغيير الخلفية</button>
<button id="addPageBtn" class="page-btn">📄 إضافة صفحة</button>
<button id="prevPageBtn" class="page-btn">◀ الصفحة السابقة</button>
<button id="nextPageBtn" class="page-btn">▶ الصفحة التالية</button>
<button id="increaseFontBtn" class="font-btn">🔠 تكبير الخط</button>
<button id="decreaseFontBtn" class="font-btn">🔡 تصغير الخط</button>
</div>
<div id="siteList" aria-live="polite"></div>
</div>

<div class="side">
<div class="list-panel">
<h3>قائمة المواقع</h3>
<div class="sites-list-short" id="sitesShort"></div>
</div>

<div class="chat-panel">
<h3>الدردشة الحية</h3>
<div id="chatBox"></div>
<div class="chat-controls">
<input id="chatMessage" placeholder="اكتب رسالتك..." />
<button type="button" onclick="toggleEmojiPanel()">😊</button>
<button id="sendMsgBtn">📨</button>
</div>
<div id="emojiPanel" class="emoji-panel"></div>
<div id="chatHint" class="small">سجّل الدخول لتستطيع الكتابة.</div>
</div>
</div>
</div>

<footer>© مكتبتي للمواقع — BBE</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, updateDoc, setDoc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = { /* إعدادات Firebase الخاصة بك هنا */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const addBtn=document.getElementById("addBtn");
const siteList=document.getElementById("siteList");
const sitesShort=document.getElementById("sitesShort");
const siteNameInput=document.getElementById("siteName");
const siteUrlInput=document.getElementById("siteUrl");
const siteImageInput=document.getElementById("siteImage");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const userPic=document.getElementById("userPic");
const userNameEl=document.getElementById("userName");
const chatBox=document.getElementById("chatBox");
const chatInput=document.getElementById("chatMessage");
const sendMsgBtn=document.getElementById("sendMsgBtn");
const chatHint=document.getElementById("chatHint");
const emojiPanel = document.getElementById("emojiPanel");
const changeBgBtn = document.getElementById("changeBgBtn");
const addPageBtn = document.getElementById("addPageBtn");
const prevPageBtn = document.getElementById("prevPageBtn");
const nextPageBtn = document.getElementById("nextPageBtn");
const increaseFontBtn = document.getElementById("increaseFontBtn");
const decreaseFontBtn = document.getElementById("decreaseFontBtn");

let currentUser=null;
let editId=null;
let currentPageIndex=0;
let pages=[];

// --- Authentication ---
loginBtn.addEventListener("click", async()=>{try{await signInWithPopup(auth,provider);}catch(e){alert("فشل تسجيل الدخول: "+e.message);}});
logoutBtn.addEventListener("click", async()=>{await signOut(auth);});
onAuthStateChanged(auth, async user=>{
    currentUser=user||null;
    loginBtn.style.display=user?"none":"inline-block";
    logoutBtn.style.display=user?"inline-block":"none";
    userPic.src=user?.photoURL||"";
    userPic.style.display=user?.photoURL?"inline-block":"none";
    userNameEl.textContent=user?.displayName||user?.email||"مستخدم";
    userNameEl.style.display=user?"inline-block":"none";
    chatHint.textContent=user?"مسجّل الدخول — يمكنك إرسال الرسائل وإضافة المواقع.":"سجّل الدخول لتستطيع الكتابة.";

    if(user){
        const userDocRef = doc(db,"users",user.uid);
        const userDoc = await getDoc(userDocRef);
        if(userDoc.exists()){
            const data=userDoc.data();
            if(data.bgUrl){ document.body.style.background = `url(${data.bgUrl}) no-repeat center center fixed`; document.body.style.backgroundSize="cover"; }
            if(data.fontSize){ document.documentElement.style.setProperty('--font-size', data.fontSize+'px'); }
            pages = Array.isArray(data.pages)? data.pages : [[]];
        } else {
            pages = [[]];
            await setDoc(userDocRef, {pages}, {merge:true});
        }
        if(currentPageIndex>=pages.length) currentPageIndex=pages.length-1;
        renderSites();
    }else{
        document.body.style.background="linear-gradient(180deg,#eef6fb,#f4f6f9)";
    }
});

// --- Pages ---
function addPage(){ pages.push([]); currentPageIndex=pages.length-1; savePages(); renderSites(); }
function prevPage(){ if(currentPageIndex>0){ currentPageIndex--; renderSites(); } }
function nextPage(){ if(currentPageIndex<pages.length-1){ currentPageIndex++; renderSites(); } }
async function savePages(){ if(!currentUser) return; await setDoc(doc(db,"users",currentUser.uid), {pages}, {merge:true}); }

// --- Sites rendering ---
function renderSites(){
    siteList.innerHTML=""; sitesShort.innerHTML="";
    const currentPage = pages[currentPageIndex]||[];
    currentPage.forEach(site=>{
        const card=document.createElement("div"); card.className="card";
        card.style.left=site.left||"0px"; card.style.top=site.top||"0px";
        card.style.width=site.width||"200px"; card.style.height=site.height||"250px";
        const img=document.createElement("img"); img.src=site.image||"https://via.placeholder.com/200x250";
        img.onclick=()=>window.open(site.url,"_blank");
        const content=document.createElement("div"); content.className="card-content";
        const title=document.createElement("h3"); title.textContent=site.name;
        const actions=document.createElement("div"); actions.className="actions";
        const editBtn=document.createElement("button"); editBtn.className="edit"; editBtn.textContent="✏️ تعديل"; editBtn.onclick=()=>openEdit(site.id);
        const deleteBtn=document.createElement("button"); deleteBtn.className="delete"; deleteBtn.textContent="🗑 حذف"; deleteBtn.onclick=()=>deleteSite(site.id);
        actions.appendChild(editBtn); actions.appendChild(deleteBtn);
        content.appendChild(title); content.appendChild(actions);
        const dragHandle=document.createElement("div"); dragHandle.className="drag-handle";
        const resizeHandle=document.createElement("div"); resizeHandle.className="resize-handle";
        card.appendChild(img); card.appendChild(content); card.appendChild(dragHandle); card.appendChild(resizeHandle);
        enableDragResize(card,site);
        siteList.appendChild(card);

        const short=document.createElement("div"); short.className="site-item";
        short.innerHTML=`<img src="${site.image||'https://via.placeholder.com/48x36'}"><a href="${site.url}" target="_blank">${site.name}</a>`;
        sitesShort.appendChild(short);
    });
}

// --- Add/Edit site ---
addBtn.addEventListener("click",()=>{
    if(!currentUser){ alert("سجّل الدخول أولاً"); return; }
    const name=siteNameInput.value.trim(), url=siteUrlInput.value.trim();
    if(!name||!url){ alert("املأ الاسم والرابط"); return; }
    const image=siteImageInput.value.trim()||"";
    const site={id:Date.now().toString(), name, url, image, left:"0px", top:"0px", width:"200px", height:"250px"};
    if(editId){ 
        let currentPage = pages[currentPageIndex]; 
        const index=currentPage.findIndex(s=>s.id===editId); 
        if(index>=0){ currentPage[index].name=name; currentPage[index].url=url; currentPage[index].image=image; } 
        editId=null; addBtn.textContent="➕ إضافة"; 
    }else{ pages[currentPageIndex].push(site); }
    siteNameInput.value=""; siteUrlInput.value=""; siteImageInput.value="";
    savePages(); renderSites();
});
function openEdit(id){ 
    const site = pages[currentPageIndex].find(s=>s.id===id); 
    if(site){ editId=id; siteNameInput.value=site.name; siteUrlInput.value=site.url; siteImageInput.value=site.image; addBtn.textContent="💾 حفظ التعديل"; }
}
function deleteSite(id){ 
    if(confirm("هل تريد حذف الموقع؟")){ 
        let currentPage = pages[currentPageIndex]; 
        pages[currentPageIndex] = currentPage.filter(s=>s.id!==id); 
        savePages(); renderSites(); 
    }
}

// --- Drag & Resize ---
function enableDragResize(card,site){
    let offsetX=0,offsetY=0,isDragging=false;
    let startWidth=0,startHeight=0,isResizing=false;
    const dragHandle=card.querySelector(".drag-handle");
    const resizeHandle=card.querySelector(".resize-handle");

    dragHandle.addEventListener("mousedown",e=>{
        isDragging=true; offsetX=e.clientX-card.offsetLeft; offsetY=e.clientY-card.offsetTop;
        document.body.style.userSelect="none";
    });
    resizeHandle.addEventListener("mousedown",e=>{
        isResizing=true; startWidth=card.offsetWidth; startHeight=card.offsetHeight; offsetX=e.clientX; offsetY=e.clientY;
        document.body.style.userSelect="none";
    });
    document.addEventListener("mousemove",e=>{
        if(isDragging){ card.style.left=e.clientX-offsetX+"px"; card.style.top=e.clientY-offsetY+"px"; }
        if(isResizing){ card.style.width=Math.max(100,startWidth+(e.clientX-offsetX))+"px"; card.style.height=Math.max(120,startHeight+(e.clientY-offsetY))+"px"; }
    });
    document.addEventListener("mouseup",()=>{
        if(isDragging||isResizing){
            site.left=card.style.left; site.top=card.style.top;
            site.width=card.style.width; site.height=card.style.height;
            savePages(); isDragging=false; isResizing=false; document.body.style.userSelect="auto";
        }
    });
}

// --- Page buttons ---
addPageBtn.addEventListener("click", addPage);
prevPageBtn.addEventListener("click", prevPage);
nextPageBtn.addEventListener("click", nextPage);

// --- Font size ---
increaseFontBtn.addEventListener("click",()=>{ 
    let size=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size'));
    size+=2; document.documentElement.style.setProperty('--font-size',size+'px'); 
    if(currentUser) setDoc(doc(db,"users",currentUser.uid), {fontSize:size}, {merge:true});
});
decreaseFontBtn.addEventListener("click",()=>{ 
    let size=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size'));
    size=Math.max(10,size-2); document.documentElement.style.setProperty('--font-size',size+'px'); 
    if(currentUser) setDoc(doc(db,"users",currentUser.uid), {fontSize:size}, {merge:true});
});

// --- Background ---
changeBgBtn.addEventListener("click",()=>{
    const url=prompt("ادخل رابط الخلفية:"); if(url){ document.body.style.background=`url(${url}) no-repeat center center fixed`; document.body.style.backgroundSize="cover";
    if(currentUser) setDoc(doc(db,"users",currentUser.uid), {bgUrl:url}, {merge:true}); }
});

// --- Chat ---
function toggleEmojiPanel(){ emojiPanel.style.display = emojiPanel.style.display==="block"?"none":"block"; }
const emojis = ["😀","😂","😍","🥰","😎","👍","🎉","💡","🔥","💬"];
emojis.forEach(e=>{ const span=document.createElement("span"); span.textContent=e; span.onclick=()=>{ chatInput.value+=e; }; emojiPanel.appendChild(span); });
sendMsgBtn.addEventListener("click",()=>{ const msg=chatInput.value.trim(); if(!msg||!currentUser) return; const chatRef = collection(db,"chats"); addDoc(chatRef,{uid:currentUser.uid,name:currentUser.displayName,text:msg,time:Date.now()}); chatInput.value=""; });
onSnapshot(query(collection(db,"chats"), orderBy("time")), snapshot=>{
    chatBox.innerHTML=""; snapshot.docs.forEach(d=>{ const data=d.data(); const div=document.createElement("div"); div.className="msg"; div.textContent=`${data.name}: ${data.text}`; chatBox.appendChild(div); }); chatBox.scrollTop=chatBox.scrollHeight;
});
</script>

</body>
</html>
