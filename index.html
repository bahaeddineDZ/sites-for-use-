<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>📚 مكتبتي للمواقع - Baha - (نسخة مطوّلة ومفصّلة)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* ==================================================
   أنماط عامة — Extended detailed styles
   الهدف: مظهر أنيق، تباين جيد، تحكم كامل باللوحات والبطاقات
   ================================================== */
:root{
  --primary:#2c3e50;
  --accent:#2980b9;
  --danger:#e74c3c;
  --success:#27ae60;
  --muted:#7f8c8d;
  --card:#ffffff;
  --glass: rgba(255,255,255,0.6);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;}
body{font-family:Tahoma, Arial, sans-serif;background:linear-gradient(180deg,#eef6fb,#f4f6f9);color:var(--primary);display:flex;flex-direction:column}

/* Header */
header{background:var(--primary);color:white;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
header h1{font-size:18px;margin:0}
.user-area{display:flex;align-items:center;gap:10px}
.user-pic{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.16)}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid rgba(0,0,0,0.06)}

/* Layout */
.layout{display:flex;gap:18px;padding:18px;flex:1;align-items:flex-start;position:relative}
.board{flex:1;min-width:320px;position:relative}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.controls input{padding:10px;border-radius:10px;border:1px solid #d0d7de;font-size:14px;flex:1;min-width:140px}
.controls .add-btn{background:var(--accent);padding:10px 16px;border-radius:10px;color:#fff;border:none;cursor:pointer}
.controls .bg-btn{background:var(--success);color:#fff;padding:10px 16px;border-radius:10px;border:none;cursor:pointer}

/* Site cards area */
#siteList{position:relative;min-height:420px;border-radius:12px;padding:12px;background:transparent}
.card{position:absolute;width:200px;height:250px;border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,0.12);overflow:hidden;background:var(--card);transition:transform .15s;border:1px solid rgba(0,0,0,0.04)}
.card:hover{transform:translateY(-6px)}
.card img{width:100%;height:100%;object-fit:cover;display:block;cursor:pointer}
.card-content{position:absolute;left:0;right:0;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,0.5), rgba(0,0,0,0.35));color:#fff;padding:8px;text-align:center}
.card-content h3{margin:0;font-size:14px}
.card .drag-handle{position:absolute;top:6px;right:6px;width:22px;height:22px;background:var(--accent);border-radius:6px;cursor:move;z-index:20;display:flex;align-items:center;justify-content:center;color:#fff}
.card .resize-handle{position:absolute;left:6px;bottom:6px;width:18px;height:18px;background:var(--success);clip-path:polygon(0 100%,100% 100%,0 0);cursor:nwse-resize;z-index:20}
.card .actions button{margin:2px;padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
.card .actions .delete{background:var(--danger);color:#fff}
.card .actions .edit{background:#f39c12;color:#fff}

/* Side panels (list & chat) - now more detailed and lengthy styles */
.list-panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.06);min-height:180px;position:absolute;left:20px;top:20px;width:320px;height:240px;z-index:40;border:1px solid rgba(0,0,0,0.06)}
.list-panel h3{margin:0 0 8px 0;font-size:16px;color:var(--primary)}
.sites-list-short{display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 56px);overflow:auto}
.site-item{display:flex;gap:8px;align-items:center}
.site-item img{width:48px;height:36px;object-fit:cover;border-radius:6px}
.site-item a{color:var(--accent);text-decoration:none;display:block}

.chat-panel{display:flex;flex-direction:column;gap:8px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.06);position:absolute;right:20px;top:240px;width:360px;height:420px;z-index:38;border:1px solid rgba(0,0,0,0.06)}
.chat-panel h3{margin:0 0 4px 0;font-size:16px;color:var(--primary)}
#chatBox{overflow:auto;border-radius:8px;padding:8px;background:#fbfdff;border:1px solid #eef5fb;height:calc(100% - 140px)}
.msg{display:inline-block;padding:8px 12px;margin:5px 0;border-radius:15px;max-width:70%;clear:both;word-wrap:break-word}
.chat-controls{display:flex;gap:5px;margin-top:6px;position:relative}
.chat-controls input{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px}
.chat-controls button{padding:8px 12px;border:none;border-radius:6px;background:#2980b9;color:white;cursor:pointer}
.chat-controls button:hover{background:#1f5f87}
.emoji-panel{display:none;background:white;border:1px solid #ccc;border-radius:10px;padding:10px;max-height:120px;overflow-y:auto;position:absolute;bottom:60px;right:10px;z-index:1000;box-shadow:0 6px 12px rgba(0,0,0,0.15);transition:all 0.2s ease}
.emoji-panel span{cursor:pointer;font-size:20px;margin:5px}
#chatHint{margin-top:8px;font-size:12px;color:gray;text-align:center}

/* Panel handles (green) */
.panel-drag-handle{position:absolute;top:8px;right:8px;width:28px;height:28px;background:var(--success);border-radius:8px;cursor:move;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;z-index:60}
.panel-resize-handle{position:absolute;left:8px;bottom:8px;width:20px;height:20px;background:var(--success);clip-path:polygon(0 100%,100% 100%,0 0);cursor:nwse-resize;z-index:60}

/* Responsive tweaks */
@media(max-width:900px){.layout{flex-direction:column}.side{width:100%}.list-panel{position:static;width:auto;height:auto}.chat-panel{position:static;width:auto;height:auto}}

/* Utility */
.hidden{display:none}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<header>
  <h1>📚 مكتبتي للمواقع - Baha -</h1>
  <div class="user-area" id="userArea">
    <img id="userPic" class="user-pic" src="" alt="" style="display:none">
    <div id="userName" class="small" style="display:none"></div>
    <button id="loginBtn" class="btn">🔑 تسجيل الدخول</button>
    <button id="logoutBtn" class="btn secondary" style="display:none">تسجيل الخروج</button>
  </div>
</header>

<div class="layout">
  <div class="board">
    <div class="controls">
      <input id="siteName" placeholder="اسم الموقع">
      <input id="siteUrl" placeholder="رابط الموقع (https://)">
      <input id="siteImage" placeholder="رابط صورة (اختياري)">
      <button id="addBtn" class="add-btn">➕ إضافة</button>
      <button id="changeBgBtn" class="bg-btn">🎨 تغيير الخلفية</button>
    </div>
    <div id="siteList" aria-live="polite"></div>
  </div>

  <!-- لوحة المواقع -->
  <div class="list-panel" id="listPanel" style="position:absolute; left:20px; top:20px; width:320px; height:240px;">
    <div class="panel-drag-handle" title="اسحب">⬍</div>
    <h3>قائمة المواقع</h3>
    <div class="sites-list-short" id="sitesShort"></div>
    <div class="panel-resize-handle" title="تغيير الحجم"></div>
  </div>

  <!-- لوحة الدردشة -->
  <div class="chat-panel" id="chatPanel" style="position:absolute; right:20px; top:260px; width:380px; height:420px;">
    <div class="panel-drag-handle" title="اسحب">⬍</div>
    <h3>الدردشة الحية</h3>
    <div id="chatBox"></div>
    <div class="chat-controls">
      <input id="chatMessage" placeholder="اكتب رسالتك..." />
      <button type="button" onclick="toggleEmojiPanel()">😊</button>
      <button id="sendMsgBtn">📨</button>
    </div>
    <div id="emojiPanel" class="emoji-panel"></div>
    <div id="chatHint" class="small">سجّل الدخول لتستطيع الكتابة.</div>
    <div class="panel-resize-handle" title="تغيير الحجم"></div>
  </div>

</div>

<footer style="padding:10px;text-align:center;color:var(--muted);font-size:13px;">© مكتبتي للمواقع — BBE</footer>

<script type="module">
/*
  =====================================================
  Extended JavaScript: كامل مفصّل وواضح لحفظ اللوحات والبيانات في Firestore
  - يدعم: تسجيل دخول عبر Google (Firebase Auth)
  - حفظ واسترجاع: مواقع (sites) + رسائل الدردشة (chat)
  - حفظ مواضع وحجوم الألواح للمستخدم في مجموعة users/<uid>/panels
  - يحافظ على كل الوظائف الأصلية ويضيف تفاصيل مرئية وتعليقات
  =====================================================
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// ----------------------------
// ضع هنا إعدادات Firebase الخاصة بك
// ----------------------------
const firebaseConfig = {
  apiKey: "AIzaSyAMJkL6Fvv9kzgWtHz7ccp79H80EhLogqk",
  authDomain: "site-for-use.firebaseapp.com",
  projectId: "site-for-use",
  storageBucket: "site-for-use.appspot.com",
  messagingSenderId: "44820921915",
  appId: "1:44820921915:web:27ff432c93b013e7a2a61e",
  measurementId: "G-LRLK1DGEX7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// ----------------------------
// عناصر DOM المهمة
// ----------------------------
const addBtn=document.getElementById("addBtn");
const siteList=document.getElementById("siteList");
const sitesShort=document.getElementById("sitesShort");
const siteNameInput=document.getElementById("siteName");
const siteUrlInput=document.getElementById("siteUrl");
const siteImageInput=document.getElementById("siteImage");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const userPic=document.getElementById("userPic");
const userNameEl=document.getElementById("userName");
const chatBox=document.getElementById("chatBox");
const chatInput=document.getElementById("chatMessage");
const sendMsgBtn=document.getElementById("sendMsgBtn");
const chatHint=document.getElementById("chatHint");
const emojiPanel = document.getElementById("emojiPanel");
const changeBgBtn = document.getElementById("changeBgBtn");
const listPanel = document.getElementById('listPanel');
const chatPanel = document.getElementById('chatPanel');

let currentUser=null;
let editId=null;

// ----------------------------
// Authentication: Google Sign-In
// ----------------------------
loginBtn.addEventListener("click",async()=>{
  try{
    await signInWithPopup(auth,provider);
  }catch(e){
    alert("فشل تسجيل الدخول: "+e.message);
  }
});
logoutBtn.addEventListener("click",async()=>{await signOut(auth);});

onAuthStateChanged(auth, async (user)=>{
  currentUser=user||null;
  loginBtn.style.display=user?"none":"inline-block";
  logoutBtn.style.display=user?"inline-block":"none";
  userPic.src=user?.photoURL||"";
  userPic.style.display=user?.photoURL?"inline-block":"none";
  userNameEl.textContent=user?.displayName||user?.email||"مستخدم";
  userNameEl.style.display=user?"inline-block":"none";
  chatHint.textContent=user?"مسجّل الدخول — يمكنك إرسال الرسائل وإضافة المواقع.":"سجّل الدخول لتستطيع الكتابة.";

  // عند تسجيل الدخول: حاول استرجاع إعدادات اللوحات من Firestore
  if(user){
    try{
      const panelDoc = await getDoc(doc(db, "users", user.uid));
      if(panelDoc.exists()){
        const data = panelDoc.data();
        if(data.panels){
          applyPanelsFromObject(data.panels);
        }
        if(data.bgUrl){
          document.body.style.background = `url(${data.bgUrl}) no-repeat center center fixed`;
          document.body.style.backgroundSize = "cover";
        }
      }
    }catch(e){console.warn('Error fetching user panels', e)}
  } else {
    // لم يعد هناك مستخدم؛ يمكن إعادة الخلفية الافتراضية
    document.body.style.background = "linear-gradient(180deg,#eef6fb,#f4f6f9)";
  }
});

// ----------------------------
// Firestore: Sites realtime
// ----------------------------
const sitesCol = collection(db, "sites");
// الاستماع للتحديثات الحية على مواقع المستخدم
onSnapshot(sitesCol, snapshot=>{
  // تنظيف الحاويات
  siteList.innerHTML = "";
  sitesShort.innerHTML = "";
  snapshot.forEach(docSnap=>{
    const site = docSnap.data(); const id = docSnap.id;

    // إنشاء بطاقة مرئية مشابهة لكودك الأصلي
    const card = document.createElement('div');
    card.className = 'card';
    card.style.left = site.left || '0px'; card.style.top = site.top || '0px';
    card.style.width = site.width || '200px'; card.style.height = site.height || '250px';

    const img = document.createElement('img');
    img.src = site.image || 'https://via.placeholder.com/200x250';
    img.alt = site.name || 'موقع';
    img.onclick = ()=> window.open(site.url, '_blank');

    const content = document.createElement('div'); content.className='card-content';
    const title = document.createElement('h3'); title.textContent = site.name;
    const actions = document.createElement('div'); actions.className='actions';
    const editBtn = document.createElement('button'); editBtn.className='edit'; editBtn.textContent='✏️ تعديل'; editBtn.onclick = ()=> openEdit(id);
    const deleteBtn = document.createElement('button'); deleteBtn.className='delete'; deleteBtn.textContent='🗑 حذف'; deleteBtn.onclick = ()=> deleteDoc(doc(db,'sites',id));
    actions.appendChild(editBtn); actions.appendChild(deleteBtn);

    content.appendChild(title); content.appendChild(actions);
    const dragHandle = document.createElement('div'); dragHandle.className='drag-handle'; dragHandle.title='اسحب'; dragHandle.textContent='⇅';
    const resizeHandle = document.createElement('div'); resizeHandle.className='resize-handle';

    card.appendChild(img); card.appendChild(content); card.appendChild(dragHandle); card.appendChild(resizeHandle);

    // أضف الوظائف الاحترافية للسحب والتغيير (مثل النسخة الأصلية)
    enableCardDragResize(card,id);

    siteList.appendChild(card);

    // نسخة قصيرة في اللوحة الجانبية
    const shortEl = document.createElement('div'); shortEl.className='site-item';
    shortEl.innerHTML = `<img src="${site.image||'https://via.placeholder.com/48x36'}"><a href="${site.url}" target="_blank">${site.name}</a>`;
    sitesShort.appendChild(shortEl);
  });
});

// إضافة/تحرير مواقع
addBtn.addEventListener('click', async ()=>{
  if(!currentUser){ alert('سجّل الدخول أولاً'); return; }
  const name = siteNameInput.value.trim(); const url = siteUrlInput.value.trim(); const image = siteImageInput.value.trim() || '';
  if(!name || !url){ alert('املأ الاسم والرابط'); return; }
  if(editId){
    await updateDoc(doc(db,'sites',editId), { name, url, image });
    editId = null; addBtn.textContent='➕ إضافة';
  } else {
    await addDoc(sitesCol, { name, url, image, left:'0px', top:'0px', width:'200px', height:'250px' });
  }
  siteNameInput.value=''; siteUrlInput.value=''; siteImageInput.value='';
});

function openEdit(id){ editId = id; getDoc(doc(db,'sites',id)).then(snap=>{ const data = snap.data(); siteNameInput.value=data.name; siteUrlInput.value=data.url; siteImageInput.value=data.image||''; addBtn.textContent='💾 حفظ التعديل'; }); }

// ----------------------------
// حفظ واسترجاع الدردشة
// ----------------------------
const chatCol = collection(db, 'chat');
// Stream live chat ordered by timestamp
onSnapshot(query(chatCol, orderBy('timestamp')), snapshot=>{
  chatBox.innerHTML='';
  snapshot.forEach(docSnap=>{
    const msg = docSnap.data();
    const div = document.createElement('div'); div.className = 'msg ' + (msg.uid===currentUser?.uid ? 'me' : 'other');
    const userInfo = document.createElement('div'); userInfo.style.display='flex'; userInfo.style.alignItems='center'; userInfo.style.gap='6px'; userInfo.style.marginBottom='4px';
    const img = document.createElement('img'); img.src = msg.photoURL || 'https://via.placeholder.com/24'; img.style.width='24px'; img.style.height='24px'; img.style.borderRadius='50%'; img.style.objectFit='cover';
    const name = document.createElement('span'); name.textContent = msg.displayName || 'مستخدم'; name.style.fontSize='12px'; name.style.color = msg.uid===currentUser?.uid? '#fff' : '#555';
    userInfo.appendChild(img); userInfo.appendChild(name);
    const textDiv = document.createElement('div'); textDiv.textContent = msg.text;
    div.appendChild(userInfo); div.appendChild(textDiv);
    div.style.maxWidth='70%'; div.style.marginBottom='6px'; div.style.clear='both'; div.style.padding='6px 10px'; div.style.borderRadius='12px'; div.style.wordWrap='break-word';
    div.style.background = msg.uid===currentUser?.uid? '#2980b9' : '#e0e0e0'; div.style.color = msg.uid===currentUser?.uid? '#fff' : '#000';
    div.style.float = msg.uid===currentUser?.uid? 'right' : 'left';
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
});

sendMsgBtn.addEventListener('click', sendMsg);
chatInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMsg(); });
async function sendMsg(){
  if(!currentUser){ alert('سجّل الدخول أولاً'); return; }
  const text = chatInput.value.trim(); if(!text) return;
  await addDoc(chatCol, { text, uid: currentUser.uid, displayName: currentUser.displayName, photoURL: currentUser.photoURL, timestamp: new Date() });
  chatInput.value='';
}

// ----------------------------
// Card drag & resize (kept as original but expanded comments)
// ----------------------------
function enableCardDragResize(card, id){
  // variables for dragging
  let offsetX=0, offsetY=0, isDragging=false;
  // variables for resizing
  let startWidth=0, startHeight=0, isResizing=false;

  const dragHandle = card.querySelector('.drag-handle');
  const resizeHandle = card.querySelector('.resize-handle');

  // mousedown on drag handle -> start dragging
  dragHandle.addEventListener('mousedown', e=>{
    isDragging = true;
    // compute offset between pointer and card top-left
    offsetX = e.clientX - card.offsetLeft;
    offsetY = e.clientY - card.offsetTop;
    document.body.style.userSelect = 'none';
  });

  // mousedown on resize handle -> start resizing
  resizeHandle.addEventListener('mousedown', e=>{
    isResizing = true;
    startWidth = card.offsetWidth; startHeight = card.offsetHeight;
    offsetX = e.clientX; offsetY = e.clientY;
    document.body.style.userSelect = 'none';
  });

  // mousemove global -> update drag/resize
  document.addEventListener('mousemove', async (e)=>{
    if(isDragging){
      card.style.left = (e.clientX - offsetX) + 'px';
      card.style.top = (e.clientY - offsetY) + 'px';
    }
    if(isResizing){
      card.style.width = Math.max(100, startWidth + (e.clientX - offsetX)) + 'px';
      card.style.height = Math.max(120, startHeight + (e.clientY - offsetY)) + 'px';
    }
  });

  // mouseup -> store final position/size in Firestore
  document.addEventListener('mouseup', async ()=>{
    if(isDragging || isResizing){
      try{
        // حاول تحديث المستند في Firestore بحقول الموضع والحجم
        await updateDoc(doc(db,'sites',id), { left: card.style.left, top: card.style.top, width: card.style.width, height: card.style.height });
      }catch(e){
        // ربما المستند لم يكن موجودًا - لا نريد أن نكسر وظائف الموقع
        // نكتفي بالإشعار في الكونسول
        console.warn('خطأ عند تحديث موقع/حجم البطاقة:', e);
      }
    }
    isDragging=false; isResizing=false; document.body.style.userSelect = 'auto';
  });
}

// ----------------------------
// Panels drag & resize: save panels per-user in Firestore under users/<uid>/panels
// - عند تغيير موضع أو حجم أي لوحة، يتم حفظ الحالة في doc(users/<uid>) مع حقل panels
// ----------------------------
function enablePanelDragResize(panel, storageKey){
  // read handles specific to panels
  const dragHandle = panel.querySelector('.panel-drag-handle');
  const resizeHandle = panel.querySelectorAll('.panel-resize-handle'); // could be two handles inside panel

  let startX=0, startY=0, startLeft=0, startTop=0, startWidth=0, startHeight=0;
  let isDragging=false, isResizing=false;

  // drag start
  dragHandle.addEventListener('mousedown', e=>{
    isDragging = true;
    startX = e.clientX; startY = e.clientY;
    // compute start left/top (may be px or empty)
    startLeft = parseInt(panel.style.left || panel.offsetLeft);
    startTop = parseInt(panel.style.top || panel.offsetTop);
    document.body.style.userSelect = 'none';
  });

  // resize start (we may have multiple resize handles; attach to each)
  resizeHandle.forEach(handle=>{
    handle.addEventListener('mousedown', e=>{
      isResizing = true;
      startX = e.clientX; startY = e.clientY;
      startWidth = panel.offsetWidth; startHeight = panel.offsetHeight;
      document.body.style.userSelect = 'none';
    });
  });

  // global move
  document.addEventListener('mousemove', e=>{
    if(isDragging){
      const dx = e.clientX - startX; const dy = e.clientY - startY;
      panel.style.left = (startLeft + dx) + 'px';
      panel.style.top = (startTop + dy) + 'px';
    }
    if(isResizing){
      const dx = e.clientX - startX; const dy = e.clientY - startY;
      panel.style.width = Math.max(180, startWidth + dx) + 'px';
      panel.style.height = Math.max(140, startHeight + dy) + 'px';
      // adjust inner chat box if needed
      if(panel.id === 'chatPanel'){
        chatBox.style.height = (panel.clientHeight - 140) + 'px';
      }
    }
  });

  document.addEventListener('mouseup', async ()=>{
    if(isDragging || isResizing){
      // save to Firestore under user's doc
      if(currentUser){
        try{
          const userRef = doc(db,'users',currentUser.uid);
          // read existing doc and merge panels
          const snapshot = await getDoc(userRef);
          let panels = {};
          if(snapshot.exists()){ panels = snapshot.data().panels || {}; }
          panels[storageKey] = { left: panel.style.left || panel.offsetLeft + 'px', top: panel.style.top || panel.offsetTop + 'px', width: panel.style.width || panel.offsetWidth + 'px', height: panel.style.height || panel.offsetHeight + 'px' };
          await setDoc(userRef, { panels }, { merge:true });
        }catch(e){ console.warn('تعذر حفظ حالة اللوحة في Firestore', e); }
      } else {
        // إذا لم يكن هناك مستخدم، نحفظ محليًا كنسخة احتياطية
        savePanelState(storageKey, panel);
      }
    }
    isDragging=false; isResizing=false; document.body.style.userSelect = 'auto';
  });
}

// helper: save to localStorage
function savePanelState(key, panel){
  try{
    const data = JSON.parse(localStorage.getItem('panelPositions') || '{}');
    data[key] = { left: panel.style.left || panel.offsetLeft + 'px', top: panel.style.top || panel.offsetTop + 'px', width: panel.style.width || panel.offsetWidth + 'px', height: panel.style.height || panel.offsetHeight + 'px' };
    localStorage.setItem('panelPositions', JSON.stringify(data));
  }catch(e){ console.warn('تعذر حفظ حالة اللوحة محليًا', e); }
}

function applySavedPanels(){
  try{
    const data = JSON.parse(localStorage.getItem('panelPositions') || '{}');
    if(data.listPanel){
      listPanel.style.position = 'absolute';
      listPanel.style.left = data.listPanel.left; listPanel.style.top = data.listPanel.top; listPanel.style.width = data.listPanel.width; listPanel.style.height = data.listPanel.height;
    }
    if(data.chatPanel){
      chatPanel.style.position = 'absolute';
      chatPanel.style.left = data.chatPanel.left || chatPanel.style.left; chatPanel.style.top = data.chatPanel.top || chatPanel.style.top;
      chatPanel.style.width = data.chatPanel.width; chatPanel.style.height = data.chatPanel.height;
      chatBox.style.height = (chatPanel.clientHeight - 140) + 'px';
    }
  }catch(e){ console.warn('تعذر قراءة حالة اللوحات من التخزين المحلي', e); }
}

function applyPanelsFromObject(obj){
  try{
    if(obj.listPanel){ listPanel.style.position='absolute'; listPanel.style.left = obj.listPanel.left; listPanel.style.top = obj.listPanel.top; listPanel.style.width = obj.listPanel.width; listPanel.style.height = obj.listPanel.height; }
    if(obj.chatPanel){ chatPanel.style.position='absolute'; chatPanel.style.left = obj.chatPanel.left || chatPanel.style.left; chatPanel.style.top = obj.chatPanel.top || chatPanel.style.top; chatPanel.style.width = obj.chatPanel.width; chatPanel.style.height = obj.chatPanel.height; chatBox.style.height = (chatPanel.clientHeight - 140) + 'px'; }
  }catch(e){ console.warn('خطأ تطبيق حالة اللوحات من Firestore', e); }
}

// apply local saved panels immediately (if exist)
applySavedPanels();

// enable panels
enablePanelDragResize(listPanel, 'listPanel');
enablePanelDragResize(chatPanel, 'chatPanel');

// ----------------------------
// Emoji panel toggle
// ----------------------------
function toggleEmojiPanel(){
  if(emojiPanel.style.display==='block'){ emojiPanel.style.display='none'; }
  else{
    emojiPanel.style.display='block';
    if(!emojiPanel.hasChildNodes()){
      const emojis = "😀 😃 😄 😁 😆 😅 😂 🤣 😊 😇 🙂 🙃 😉 😌 😍 🥰 😘 😗 😙 😚 😋 😛 😜 🤪 😝 🤑 🤗 🤭 🤫 🤔 🤐 🤨 😐 😑 😶 😏".split(' ');
      emojis.forEach(e=>{ const span=document.createElement('span'); span.textContent=e; span.onclick=()=>{ chatInput.value += e; emojiPanel.style.display='none'; }; emojiPanel.appendChild(span); });
    }
  }
}

// ----------------------------
// Change background (and save in Firestore under user doc)
// ----------------------------
changeBgBtn.addEventListener('click', async ()=>{
  if(!currentUser){ alert('سجّل الدخول أولاً'); return; }
  const url = prompt('ضع رابط صورة للخلفية:');
  if(url){
    document.body.style.background = `url(${url}) no-repeat center center fixed`;
    document.body.style.backgroundSize = 'cover';
    try{
      await updateDoc(doc(db,'users',currentUser.uid), { bgUrl: url });
    }catch(e){
      // إذا لم يكن المستند موجوداً - استخدم setDoc لإنشاء مستند مع البيانات
      try{ await setDoc(doc(db,'users',currentUser.uid), { bgUrl: url }, { merge:true }); }catch(err){ console.warn('تعذر حفظ الخلفية في Firestore', err); }
    }
  }
});

// ----------------------------
// Initial listeners: realtime for chat and sites already set; now attach panel drag/resize to existing panels
// ----------------------------
// panels already enabled above

// ----------------------------
// Save panel states to Firestore on unload if user logged in
// ----------------------------
window.addEventListener('beforeunload', async ()=>{
  try{
    if(currentUser){
      const userRef = doc(db,'users',currentUser.uid);
      const panels = {
        listPanel: { left: listPanel.style.left || listPanel.offsetLeft + 'px', top: listPanel.style.top || listPanel.offsetTop + 'px', width: listPanel.style.width || listPanel.offsetWidth + 'px', height: listPanel.style.height || listPanel.offsetHeight + 'px' },
        chatPanel: { left: chatPanel.style.left || chatPanel.offsetLeft + 'px', top: chatPanel.style.top || chatPanel.offsetTop + 'px', width: chatPanel.style.width || chatPanel.offsetWidth + 'px', height: chatPanel.style.height || chatPanel.offsetHeight + 'px' }
      };
      await setDoc(userRef, { panels }, { merge:true });
    } else {
      // احفظ محلياً
      savePanelState('listPanel', listPanel); savePanelState('chatPanel', chatPanel);
    }
  }catch(e){ console.warn('تعذر حفظ حالة اللوحات عند الخروج', e); }
});

</script>
</body>
</html>
