<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“š Ù…ÙƒØªØ¨ØªÙŠ Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ - Baha - (Ù†Ø³Ø®Ø© Ù…Ø·ÙˆÙ‘Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ Ù…Ø´ØºÙ„ ØµÙˆØªÙŠØ§Øª)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ==================================================
       Ù†Ø³Ø®Ø© Ù…Ø·ÙˆÙ‘Ù„Ø© Ø¬Ø¯Ø§Ù‹ Ù…Ù† CSS â€” ÙƒÙ„ Ø®Ø§ØµÙŠØ© ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„
       ================================================== */

    :root {
      /* Ø£Ù„ÙˆØ§Ù† Ø£Ø³Ø§Ø³ÙŠØ© */
      --primary: #2c3e50;
      --accent: #2980b9;
      --danger: #e74c3c;
      --success: #27ae60;
      --muted: #7f8c8d;
      --card: #ffffff;

      /* ØªØ­ÙƒÙ… ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
      --base-font-size: 14px; /* Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
      --card-opacity: 1;      /* Ø´ÙØ§ÙÙŠØ© Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ */
      --panel-opacity: 1;     /* Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ù„ÙˆØ­Ø§Øª (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŒ Ø§Ù„Ù…Ø´ØºÙ„) */
      --img-opacity: 1;       /* Ø´ÙØ§ÙÙŠØ© Ø§Ù„ØµÙˆØ± (ØªØ·Ø¨Ù‚ Ø¥Ø°Ø§ ÙØ¹Ù„Øª Ø®ÙŠØ§Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±) */
    }

    /* Reset Ø¨Ø³ÙŠØ· */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: Tahoma, Arial, sans-serif;
      background: linear-gradient(180deg, #eef6fb, #f4f6f9);
      color: var(--primary);
      display: flex;
      flex-direction: column;
      font-size: var(--base-font-size);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header */
    header {
      background: var(--primary);
      color: #fff;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header h1 {
      font-size: 1.15rem;
      margin: 0;
    }

    .user-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-pic {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.16);
    }

    .btn {
      background: var(--accent);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .btn.secondary {
      background: #fff;
      color: var(--accent);
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    /* Layout */
    .layout {
      display: flex;
      gap: 18px;
      padding: 18px;
      flex: 1;
      align-items: flex-start;
      position: relative;
    }

    .board {
      flex: 1;
      min-width: 320px;
      position: relative;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center;
    }

    .controls input[type="text"],
    .controls input[type="url"] {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d0d7de;
      font-size: 14px;
      flex: 1;
      min-width: 140px;
    }

    .controls .add-btn {
      background: var(--accent);
      padding: 10px 16px;
      border-radius: 10px;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .controls .bg-btn {
      background: var(--success);
      color: #fff;
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }

    /* view control group */
    .view-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .view-controls .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: rgba(255,255,255,0.06);
      padding: 8px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.03);
    }

    .view-controls label {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .view-controls input[type='range'] {
      width: 160px;
    }

    .view-controls .smallVal {
      font-size: 0.85rem;
      color: var(--muted);
      text-align: center;
    }

    /* Site cards area */
    #siteList {
      position: relative;
      min-height: 420px;
      border-radius: 12px;
      padding: 12px;
      background: transparent;
    }

    .card {
      position: absolute;
      width: 200px;
      height: 250px;
      border-radius: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
      overflow: hidden;
      transition: transform .15s;
      border: 1px solid rgba(0,0,0,0.04);
      background: rgba(255,255,255,var(--card-opacity));
      opacity: 1;
    }

    .card:hover {
      transform: translateY(-6px);
    }

    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      cursor: pointer;
      opacity: var(--img-opacity);
    }

    .card-content {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.5), rgba(0,0,0,0.35));
      color: #fff;
      padding: 8px;
      text-align: center;
    }

    .card-content h3 {
      margin: 0;
      font-size: 0.95rem;
    }

    .card .drag-handle {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: var(--accent);
      border-radius: 6px;
      cursor: move;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }

    .card .resize-handle {
      position: absolute;
      left: 6px;
      bottom: 6px;
      width: 18px;
      height: 18px;
      background: var(--success);
      clip-path: polygon(0 100%, 100% 100%, 0 0);
      cursor: nwse-resize;
      z-index: 20;
    }

    .card .actions button {
      margin: 2px;
      padding: 6px 8px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .card .actions .delete {
      background: var(--danger);
      color: #fff;
    }

    .card .actions .edit {
      background: #f39c12;
      color: #fff;
    }

    /* Side panels */
    .list-panel {
      background: rgba(255,255,255,var(--panel-opacity));
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      min-height: 180px;
      position: absolute;
      left: 20px;
      top: 20px;
      width: 320px;
      height: 240px;
      z-index: 40;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .list-panel h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: var(--primary);
    }

    .sites-list-short {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: calc(100% - 56px);
      overflow: auto;
    }

    .site-item {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .site-item img {
      width: 48px;
      height: 36px;
      object-fit: cover;
      border-radius: 6px;
    }

    .site-item a {
      color: var(--accent);
      text-decoration: none;
      display: block;
    }

    .chat-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: rgba(255,255,255,var(--panel-opacity));
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      position: absolute;
      right: 20px;
      top: 260px;
      width: 380px;
      height: 420px;
      z-index: 38;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .chat-panel h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: var(--primary);
    }

    #chatBox {
      overflow: auto;
      border-radius: 8px;
      padding: 8px;
      background: #fbfdff;
      border: 1px solid #eef5fb;
      height: calc(100% - 140px);
    }

    .msg {
      display: inline-block;
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 15px;
      max-width: 70%;
      clear: both;
      word-wrap: break-word;
    }

    .chat-controls {
      display: flex;
      gap: 5px;
      margin-top: 6px;
      position: relative;
    }

    .chat-controls input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .chat-controls button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: #2980b9;
      color: white;
      cursor: pointer;
    }

    .chat-controls button:hover {
      background: #1f5f87;
    }

    .emoji-panel {
      display: none;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      max-height: 120px;
      overflow-y: auto;
      position: absolute;
      bottom: 60px;
      right: 10px;
      z-index: 1000;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
    }

    .emoji-panel span {
      cursor: pointer;
      font-size: 20px;
      margin: 5px;
    }

    #chatHint {
      margin-top: 8px;
      font-size: 12px;
      color: gray;
      text-align: center;
    }

    .panel-drag-handle {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: var(--success);
      border-radius: 8px;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 14px;
      z-index: 60;
    }

    .panel-resize-handle {
      position: absolute;
      left: 8px;
      bottom: 8px;
      width: 20px;
      height: 20px;
      background: var(--success);
      clip-path: polygon(0 100%, 100% 100%, 0 0);
      cursor: nwse-resize;
      z-index: 60;
    }

    /* Audio player card Ù…Ø·ÙˆÙ‘Ù„ */
    .audio-card {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      width: 720px;
      max-width: calc(100% - 40px);
      background: rgba(255,255,255,var(--panel-opacity));
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
      z-index: 45;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .audio-card h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .playlist {
      max-height: 160px;
      overflow: auto;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #eef5fb;
      background: #fbfdff;
    }

    .playlist li {
      list-style: none;
      padding: 6px 8px;
      border-radius: 8px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .playlist li button {
      margin-left: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .track-name {
      font-weight: bold;
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }

      .list-panel {
        position: static;
        width: auto;
        height: auto;
      }

      .chat-panel {
        position: static;
        width: auto;
        height: auto;
      }

      .audio-card {
        position: static;
        transform: none;
        width: auto;
        margin-top: 12px;
      }
    }

    .hidden { display: none; }
    .small { font-size: 12px; color: var(--muted); }

  </style>
</head>
<body>

  <header>
    <h1>ğŸ“š Ù…ÙƒØªØ¨ØªÙŠ Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ - Baha - (Ù…Ø·ÙˆÙ‘Ù„)</h1>
    <div class="user-area" id="userArea">
      <img id="userPic" class="user-pic" src="" alt="" style="display:none">
      <div id="userName" class="small" style="display:none"></div>
      <button id="loginBtn" class="btn">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button id="logoutBtn" class="btn secondary" style="display:none">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <div class="layout">

    <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
    <div class="board">

      <!-- Ù…Ù†Ø·Ù‚Ø© Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… (Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ØŒ ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø­Ø¬Ù…/Ø´ÙØ§ÙÙŠØ©) -->
      <div class="controls">
        <input id="siteName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹">
        <input id="siteUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (https://)">
        <input id="siteImage" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <button id="addBtn" class="add-btn">â• Ø¥Ø¶Ø§ÙØ©</button>
        <button id="changeBgBtn" class="bg-btn">ğŸ¨ ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù„ÙˆÙ†/ØµÙˆØ±Ø©)</button>

        <!-- view controls -->
        <div class="view-controls">
          <div class="control-group" style="min-width:220px;">
            <label for="fontSizeRange">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="fontSizeRange" type="range" min="12" max="20" step="1" value="14">
              <div id="fontSizeValue" class="smallVal">14px</div>
            </div>
          </div>

          <div class="control-group" style="min-width:220px;">
            <label for="opacityRange">Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù…</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="opacityRange" type="range" min="0.2" max="1" step="0.05" value="1">
              <div id="opacityValue" class="smallVal">100%</div>
            </div>
            <label style="display:flex;align-items:center;gap:8px;margin-top:6px;font-size:12px;color:var(--muted)"><input id="applyToImages" type="checkbox"> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±</label>
          </div>

          <div style="display:flex;flex-direction:column;justify-content:center;gap:6px;">
            <button id="resetView" class="btn secondary">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          </div>
        </div>

      </div>

      <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
      <div id="siteList" aria-live="polite"></div>

    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <div class="list-panel" id="listPanel" style="position:absolute; left:20px; top:20px; width:320px; height:240px;">
      <div class="panel-drag-handle" title="Ø§Ø³Ø­Ø¨">â¬</div>
      <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</h3>
      <div class="sites-list-short" id="sitesShort"></div>
      <div class="panel-resize-handle" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…"></div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
    <div class="chat-panel" id="chatPanel" style="position:absolute; right:20px; top:260px; width:380px; height:420px;">
      <div class="panel-drag-handle" title="Ø§Ø³Ø­Ø¨">â¬</div>
      <h3>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­ÙŠØ©</h3>
      <div id="chatBox"></div>
      <div class="chat-controls">
        <input id="chatMessage" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." />
        <button type="button" onclick="toggleEmojiPanel()">ğŸ˜Š</button>
        <button id="sendMsgBtn">ğŸ“¨</button>
      </div>
      <div id="emojiPanel" class="emoji-panel"></div>
      <div id="chatHint" class="small">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©.</div>
      <div class="panel-resize-handle" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…"></div>
    </div>

    <!-- Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØªÙŠØ§Øª ÙƒØ¨Ø·Ø§Ù‚Ø© Ø®Ø§ØµØ© ÙˆÙ…Ø·ÙˆÙ‘Ù„Ø© -->
    <div class="audio-card" id="audioCard">
      <h3>ğŸµ Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØªÙŠØ§Øª</h3>
      <div style="display:flex;gap:10px;align-items:center;">
        <div style="flex:1;">
          <div id="track-name" class="track-name">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø´ØºÙ„</div>
          <audio id="audio" controls style="width:100%;margin-top:8px"></audio>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;min-width:220px;">
          <div style="display:flex;gap:8px;">
            <button id="prevBtn" class="btn secondary">â®ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button id="nextBtn" class="btn">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
          </div>

          <div style="display:flex;gap:6px;">
            <input id="newTrackUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØª (Direct link)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd">
            <input id="newTrackName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="width:160px;padding:8px;border-radius:8px;border:1px solid #ddd">
          </div>

          <div style="display:flex;gap:6px;">
            <button id="addTrackBtn" class="btn">â• Ø£Ø¶Ù Ù„Ù„ØµÙˆØªÙŠØ§Øª</button>
            <button id="savePlaylistBtn" class="btn secondary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            <button id="clearPlaylistBtn" class="btn secondary">ğŸ—‘ ØªÙØ±ÙŠØº</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø§Ø¶ØºØ· Ù„ØªØ´ØºÙŠÙ„ØŒ Ø§Ø³Ø­Ø¨ Ù„Ø­Ø°Ù Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø§Ø³Ù…):</div>
        <ul id="playlist" class="playlist"></ul>
      </div>

      <div style="margin-top:8px;font-size:12px;color:var(--muted)">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø±ÙˆØ§Ø¨Ø· Google Drive ÙŠØ¬Ø¨ ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± (<code>https://docs.google.com/uc?export=download&id=FILE_ID</code>) Ø£Ùˆ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Firebase Storage ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.</div>
    </div>

  </div>

  <footer style="padding:10px;text-align:center;color:var(--muted);font-size:13px;">Â© Ù…ÙƒØªØ¨ØªÙŠ Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ â€” BBE</footer>

  <script type="module">
    /* ==================================================
       Ù†Ø³Ø®Ø© Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ù…Ø·ÙˆÙ‘Ù„Ø© ÙˆÙˆØ§Ø¶Ø­Ø© â€” ÙƒÙ„ Ø¯Ø§Ù„Ø© Ù…Ù‚Ø³Ù‘Ù…Ø© ÙˆØªØ¹Ù„ÙŠÙ‚Ø§Øª
       ØªØ´Ù…Ù„: Firebase init, Auth, Firestore operations,
       Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§ØªØŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŒ Ø§Ù„Ù…Ø´ØºÙ„ØŒ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ/Ø³Ø­Ø§Ø¨ÙŠ.
       ================================================== */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ----------------------------
    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase â€” Ø¶Ø¹ Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
    // ----------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyAMJkL6Fvv9kzgWtHz7ccp79H80EhLogqk",
      authDomain: "site-for-use.firebaseapp.com",
      projectId: "site-for-use",
      storageBucket: "site-for-use.appspot.com",
      messagingSenderId: "44820921915",
      appId: "1:44820921915:web:27ff432c93b013e7a2a61e",
      measurementId: "G-LRLK1DGEX7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ----------------------------
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ DOM Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    // ----------------------------
    const addBtn = document.getElementById("addBtn");
    const siteList = document.getElementById("siteList");
    const sitesShort = document.getElementById("sitesShort");
    const siteNameInput = document.getElementById("siteName");
    const siteUrlInput = document.getElementById("siteUrl");
    const siteImageInput = document.getElementById("siteImage");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userPic = document.getElementById("userPic");
    const userNameEl = document.getElementById("userName");
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatMessage");
    const sendMsgBtn = document.getElementById("sendMsgBtn");
    const chatHint = document.getElementById("chatHint");
    const emojiPanel = document.getElementById("emojiPanel");
    const changeBgBtn = document.getElementById("changeBgBtn");
    const listPanel = document.getElementById('listPanel');
    const chatPanel = document.getElementById('chatPanel');

    // Ø¹Ù†Ø§ØµØ± ØªØ­ÙƒÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const fontSizeRange = document.getElementById('fontSizeRange');
    const fontSizeValue = document.getElementById('fontSizeValue');
    const opacityRange = document.getElementById('opacityRange');
    const opacityValue = document.getElementById('opacityValue');
    const applyToImages = document.getElementById('applyToImages');
    const resetViewBtn = document.getElementById('resetView');

    // Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØªÙŠØ§Øª Ø¹Ù†Ø§ØµØ±
    const audio = document.getElementById('audio');
    const trackNameEl = document.getElementById('track-name');
    const playlistEl = document.getElementById('playlist');
    const newTrackUrl = document.getElementById('newTrackUrl');
    const newTrackName = document.getElementById('newTrackName');
    const addTrackBtn = document.getElementById('addTrackBtn');
    const savePlaylistBtn = document.getElementById('savePlaylistBtn');
    const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // Ø­Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ©
    let currentUser = null;
    let editId = null;
    let tracks = []; // Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª: { name, url }
    let currentIndex = 0;

    // ----------------------------
    // Authentication (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google â€” Ù…ÙØµÙ‘Ù„)
    // ----------------------------
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.warn('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', e);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      loginBtn.style.display = user ? "none" : "inline-block";
      logoutBtn.style.display = user ? "inline-block" : "none";
      userPic.src = user?.photoURL || "";
      userPic.style.display = user?.photoURL ? "inline-block" : "none";
      userNameEl.textContent = user?.displayName || user?.email || "Ù…Ø³ØªØ®Ø¯Ù…";
      userNameEl.style.display = user ? "inline-block" : "none";
      chatHint.textContent = user ? "Ù…Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹." : "Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©.";

      // Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø§Ø³ØªØ±Ø¬Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø®Ù„ÙÙŠØ©ØŒ Ù„ÙˆØ­Ø§ØªØŒ ÙˆØ§Ø¬Ù‡Ø©ØŒ ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„)
      if (user) {
        try {
          const userRef = doc(db, "users", user.uid);
          const snap = await getDoc(userRef);
          if (snap.exists()) {
            const data = snap.data();

            // Ø§Ù„Ø®Ù„ÙÙŠØ©
            if (data.settings && data.settings.background) {
              applyBackgroundFromObject(data.settings.background);
            } else {
              applyBackgroundFromLocal();
            }

            // Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ù„ÙˆØ­Ø§Øª
            if (data.panels) {
              applyPanelsFromObject(data.panels);
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            if (data.settings && data.settings.ui) {
              const ui = data.settings.ui;
              if (ui.fontSize) applyFontSize(ui.fontSize);
              if (typeof ui.opacity !== 'undefined') applyOpacity(ui.opacity, ui.applyToImages);
              syncUIControls(ui);
            } else {
              applyUISettingsFromLocal();
            }

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª
            if (data.settings && data.settings.playlist && Array.isArray(data.settings.playlist)) {
              tracks = data.settings.playlist.slice();
              renderPlaylist();
              if (tracks.length > 0) loadTrack(0);
            }

          } else {
            applyBackgroundFromLocal();
            applyUISettingsFromLocal();
            loadPlaylistFromLocal();
          }
        } catch (e) {
          console.warn('Ø®Ø·Ø£ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', e);
          applyBackgroundFromLocal();
          applyUISettingsFromLocal();
          loadPlaylistFromLocal();
        }
      } else {
        // Ù„Ø§ Ù…Ø³ØªØ®Ø¯Ù… â€” Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† localStorage
        applyBackgroundFromLocal();
        applyUISettingsFromLocal();
        loadPlaylistFromLocal();
      }
    });

    // ----------------------------
    // Sites handling (Firestore) â€” Ù…ÙØµÙ‘Ù„
    // ----------------------------
    const sitesCol = collection(db, "sites");

    onSnapshot(sitesCol, snapshot => {
      siteList.innerHTML = "";
      sitesShort.innerHTML = "";

      snapshot.forEach(docSnap => {
        const site = docSnap.data();
        const id = docSnap.id;

        const card = document.createElement("div");
        card.className = "card";

        card.style.left = site.left || "0px";
        card.style.top = site.top || "0px";
        card.style.width = site.width || "200px";
        card.style.height = site.height || "250px";

        const img = document.createElement("img");
        img.src = site.image || "https://via.placeholder.com/200x250";
        img.onclick = () => window.open(site.url, "_blank");

        const content = document.createElement("div");
        content.className = "card-content";

        const title = document.createElement("h3");
        title.textContent = site.name;

        const actions = document.createElement("div");
        actions.className = "actions";

        const editBtn = document.createElement("button");
        editBtn.className = "edit";
        editBtn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
        editBtn.onclick = () => openEdit(id);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete";
        deleteBtn.textContent = "ğŸ—‘ Ø­Ø°Ù";
        deleteBtn.onclick = () => deleteDoc(doc(db, "sites", id));

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        content.appendChild(title);
        content.appendChild(actions);

        const dragHandle = document.createElement("div");
        dragHandle.className = "drag-handle";
        dragHandle.title = "Ø§Ø³Ø­Ø¨";
        dragHandle.textContent = "â‡…";

        const resizeHandle = document.createElement("div");
        resizeHandle.className = "resize-handle";

        card.appendChild(img);
        card.appendChild(content);
        card.appendChild(dragHandle);
        card.appendChild(resizeHandle);

        enableCardDragResize(card, id);

        siteList.appendChild(card);

        const short = document.createElement("div");
        short.className = "site-item";
        short.innerHTML = `<img src="${site.image || 'https://via.placeholder.com/48x36'}"><a href="${site.url}" target="_blank">${site.name}</a>`;
        sitesShort.appendChild(short);
      });
    });

    // Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø±ÙŠØ± Ù…ÙˆØ§Ù‚Ø¹
    addBtn.addEventListener("click", async () => {
      if (!currentUser) { alert("Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }
      const name = siteNameInput.value.trim();
      const url = siteUrlInput.value.trim();
      if (!name || !url) { alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ø§Ø¨Ø·"); return; }
      const image = siteImageInput.value.trim() || "";

      if (editId) {
        try {
          await updateDoc(doc(db, "sites", editId), { name, url, image });
          editId = null;
          addBtn.textContent = "â• Ø¥Ø¶Ø§ÙØ©";
        } catch (e) {
          console.warn('Ø®Ø·Ø£ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹', e);
        }
      } else {
        try {
          await addDoc(sitesCol, { name, url, image, left: "0px", top: "0px", width: "200px", height: "250px" });
        } catch (e) {
          console.warn('Ø®Ø·Ø£ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹', e);
        }
      }

      siteNameInput.value = "";
      siteUrlInput.value = "";
      siteImageInput.value = "";
    });

    function openEdit(id) {
      getDoc(doc(db, "sites", id)).then(snap => {
        const data = snap.data();
        siteNameInput.value = data.name;
        siteUrlInput.value = data.url;
        siteImageInput.value = data.image || "";
        addBtn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
        editId = id;
      }).catch(e => console.warn('Ø®Ø·Ø£ ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', e));
    }

    // ----------------------------
    // Chat handling (Firestore)
    // ----------------------------
    const chatCol = collection(db, "chat");

    onSnapshot(query(chatCol, orderBy("timestamp")), snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(docSnap => {
        const msg = docSnap.data();

        const div = document.createElement("div");
        div.className = "msg " + (msg.uid === currentUser?.uid ? "me" : "other");

        const userInfo = document.createElement("div");
        userInfo.style.display = "flex";
        userInfo.style.alignItems = "center";
        userInfo.style.gap = "6px";
        userInfo.style.marginBottom = "2px";

        const img = document.createElement("img");
        img.src = msg.photoURL || "https://via.placeholder.com/24";
        img.style.width = "24px";
        img.style.height = "24px";
        img.style.borderRadius = "50%";
        img.style.objectFit = "cover";

        const name = document.createElement("span");
        name.textContent = msg.displayName || "Ù…Ø³ØªØ®Ø¯Ù…";
        name.style.fontSize = "12px";
        name.style.color = msg.uid === currentUser?.uid ? "#fff" : "#555";

        userInfo.appendChild(img);
        userInfo.appendChild(name);

        const textDiv = document.createElement("div");
        textDiv.textContent = msg.text;

        div.appendChild(userInfo);
        div.appendChild(textDiv);

        div.style.maxWidth = "70%";
        div.style.marginBottom = "6px";
        div.style.clear = "both";
        div.style.padding = "6px 10px";
        div.style.borderRadius = "12px";
        div.style.wordWrap = "break-word";
        div.style.background = msg.uid === currentUser?.uid ? "#2980b9" : "#e0e0e0";
        div.style.color = msg.uid === currentUser?.uid ? "#fff" : "#000";
        div.style.float = msg.uid === currentUser?.uid ? "right" : "left";

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    });

    sendMsgBtn.addEventListener("click", sendMsg);

    chatInput.addEventListener("keypress", e => { if (e.key === "Enter") sendMsg(); });

    async function sendMsg() {
      if (!currentUser) { alert("Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }
      const text = chatInput.value.trim();
      if (!text) return;
      try {
        await addDoc(chatCol, { text, uid: currentUser.uid, displayName: currentUser.displayName, photoURL: currentUser.photoURL, timestamp: new Date() });
        chatInput.value = "";
      } catch (e) {
        console.warn('Ø®Ø·Ø£ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', e);
      }
    }

    // ----------------------------
    // Card drag & resize â€” ausfÃ¼hrlich
    // ----------------------------
    function enableCardDragResize(card, id) {
      // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„ØªØºÙŠÙŠØ±
      let offsetX = 0;
      let offsetY = 0;
      let isDragging = false;

      let startWidth = 0;
      let startHeight = 0;
      let isResizing = false;

      const dragHandle = card.querySelector(".drag-handle");
      const resizeHandle = card.querySelector(".resize-handle");

      // Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø­Ø¨
      dragHandle.addEventListener("mousedown", e => {
        isDragging = true;
        offsetX = e.clientX - card.offsetLeft;
        offsetY = e.clientY - card.offsetTop;
        document.body.style.userSelect = "none";
      });

      // Ø¨Ø¯Ø¡ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø­Ø¬Ù…
      resizeHandle.addEventListener("mousedown", e => {
        isResizing = true;
        startWidth = card.offsetWidth;
        startHeight = card.offsetHeight;
        offsetX = e.clientX;
        offsetY = e.clientY;
        document.body.style.userSelect = "none";
      });

      document.addEventListener("mousemove", e => {
        if (isDragging) {
          card.style.left = e.clientX - offsetX + "px";
          card.style.top = e.clientY - offsetY + "px";
        }

        if (isResizing) {
          card.style.width = Math.max(100, startWidth + (e.clientX - offsetX)) + "px";
          card.style.height = Math.max(120, startHeight + (e.clientY - offsetY)) + "px";
        }
      });

      document.addEventListener("mouseup", async () => {
        if (isDragging || isResizing) {
          try {
            await updateDoc(doc(db, "sites", id), { left: card.style.left, top: card.style.top, width: card.style.width, height: card.style.height });
          } catch (e) {
            console.warn('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ø­Ø¬Ù… ÙÙŠ Firestore:', e);
          }
          isDragging = false;
          isResizing = false;
          document.body.style.userSelect = "auto";
        }
      });
    }

    // ----------------------------
    // Panels drag & resize and save state to Firestore/localStorage â€” Ù…ÙØµÙ‘Ù„
    // ----------------------------
    function enablePanelDragResize(panel, storageKey) {
      const dragHandle = panel.querySelector('.panel-drag-handle');
      const resizeHandles = panel.querySelectorAll('.panel-resize-handle');

      let startX = 0;
      let startY = 0;
      let startLeft = 0;
      let startTop = 0;
      let startWidth = 0;
      let startHeight = 0;

      let isDragging = false;
      let isResizing = false;

      // Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø­Ø¨
      dragHandle.addEventListener('mousedown', e => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = parseInt(panel.style.left || panel.offsetLeft);
        startTop = parseInt(panel.style.top || panel.offsetTop);
        document.body.style.userSelect = 'none';
      });

      // Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
      resizeHandles.forEach(handle => {
        handle.addEventListener('mousedown', e => {
          isResizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startWidth = panel.offsetWidth;
          startHeight = panel.offsetHeight;
          document.body.style.userSelect = 'none';
        });
      });

      document.addEventListener('mousemove', e => {
        if (isDragging) {
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          panel.style.left = (startLeft + dx) + 'px';
          panel.style.top = (startTop + dy) + 'px';
        }

        if (isResizing) {
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          panel.style.width = Math.max(180, startWidth + dx) + 'px';
          panel.style.height = Math.max(140, startHeight + dy) + 'px';
          if (panel.id === 'chatPanel') chatBox.style.height = (panel.clientHeight - 140) + 'px';
        }
      });

      document.addEventListener('mouseup', async () => {
        if (isDragging || isResizing) {
          const panelState = {
            left: panel.style.left || panel.offsetLeft + 'px',
            top: panel.style.top || panel.offsetTop + 'px',
            width: panel.style.width || panel.offsetWidth + 'px',
            height: panel.style.height || panel.offsetHeight + 'px'
          };

          if (currentUser) {
            try {
              const userRef = doc(db, 'users', currentUser.uid);
              const snap = await getDoc(userRef);
              let base = {};
              if (snap.exists()) base = snap.data();
              const panels = (base.panels) ? base.panels : {};
              panels[storageKey] = panelState;
              await setDoc(userRef, { panels }, { merge: true });
            } catch (e) {
              console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø© ÙÙŠ Firestore', e);
              savePanelState(storageKey, panel);
            }
          } else {
            savePanelState(storageKey, panel);
          }
        }

        isDragging = false;
        isResizing = false;
        document.body.style.userSelect = 'auto';
      });
    }

    function savePanelState(key, panel) {
      try {
        const data = JSON.parse(localStorage.getItem('panelPositions') || '{}');
        data[key] = { left: panel.style.left || panel.offsetLeft + 'px', top: panel.style.top || panel.offsetTop + 'px', width: panel.style.width || panel.offsetWidth + 'px', height: panel.style.height || panel.offsetHeight + 'px' };
        localStorage.setItem('panelPositions', JSON.stringify(data));
      } catch (e) {
        console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ø­Ù„ÙŠØ§Ù‹', e);
      }
    }

    function applySavedPanels() {
      try {
        const data = JSON.parse(localStorage.getItem('panelPositions') || '{}');
        if (data.listPanel) {
          listPanel.style.position = 'absolute';
          listPanel.style.left = data.listPanel.left;
          listPanel.style.top = data.listPanel.top;
          listPanel.style.width = data.listPanel.width;
          listPanel.style.height = data.listPanel.height;
        }
        if (data.chatPanel) {
          chatPanel.style.position = 'absolute';
          chatPanel.style.left = data.chatPanel.left || chatPanel.style.left;
          chatPanel.style.top = data.chatPanel.top || chatPanel.style.top;
          chatPanel.style.width = data.chatPanel.width;
          chatPanel.style.height = data.chatPanel.height;
          chatBox.style.height = (chatPanel.clientHeight - 140) + 'px';
        }
      } catch (e) {
        console.warn('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø§Øª Ù…Ù† localStorage', e);
      }
    }

    function applyPanelsFromObject(obj) {
      try {
        if (obj.listPanel) {
          listPanel.style.position = 'absolute';
          listPanel.style.left = obj.listPanel.left;
          listPanel.style.top = obj.listPanel.top;
          listPanel.style.width = obj.listPanel.width;
          listPanel.style.height = obj.listPanel.height;
        }
        if (obj.chatPanel) {
          chatPanel.style.position = 'absolute';
          chatPanel.style.left = obj.chatPanel.left || chatPanel.style.left;
          chatPanel.style.top = obj.chatPanel.top || chatPanel.style.top;
          chatPanel.style.width = obj.chatPanel.width;
          chatPanel.style.height = obj.chatPanel.height;
          chatBox.style.height = (chatPanel.clientHeight - 140) + 'px';
        }
      } catch (e) {
        console.warn('Ø®Ø·Ø£ ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø§Øª Ù…Ù† Firestore', e);
      }
    }

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„ØªØºÙŠÙŠØ±
    applySavedPanels();
    enablePanelDragResize(listPanel, 'listPanel');
    enablePanelDragResize(chatPanel, 'chatPanel');

    // ----------------------------
    // Emoji panel toggle
    // ----------------------------
    function toggleEmojiPanel() {
      if (emojiPanel.style.display === 'block') {
        emojiPanel.style.display = 'none';
      } else {
        emojiPanel.style.display = 'block';
        if (!emojiPanel.hasChildNodes()) {
          const emojis = "ğŸ˜€ ğŸ˜ƒ ğŸ˜„ ğŸ˜ ğŸ˜† ğŸ˜… ğŸ˜‚ ğŸ¤£ ğŸ˜Š ğŸ˜‡ ğŸ™‚ ğŸ™ƒ ğŸ˜‰ ğŸ˜Œ ğŸ˜ ğŸ¥° ğŸ˜˜ ğŸ˜— ğŸ˜™ ğŸ˜š ğŸ˜‹ ğŸ˜› ğŸ˜œ ğŸ¤ª ğŸ˜ ğŸ¤‘ ğŸ¤— ğŸ¤­ ğŸ¤« ğŸ¤” ğŸ¤ ğŸ¤¨ ğŸ˜ ğŸ˜‘ ğŸ˜¶ ğŸ˜".split(" ");
          emojis.forEach(e => {
            const span = document.createElement('span');
            span.textContent = e;
            span.onclick = () => { chatInput.value += e; emojiPanel.style.display = 'none'; };
            emojiPanel.appendChild(span);
          });
        }
      }
    }

    // ----------------------------
    // Background: apply & save
    // ----------------------------
    function applyBackgroundFromObject(bgObj) {
      try {
        if (!bgObj) return;
        if (bgObj.type === 'color') {
          document.body.style.background = bgObj.value;
        } else if (bgObj.type === 'image') {
          document.body.style.background = `url(${bgObj.value}) no-repeat center center fixed`;
          document.body.style.backgroundSize = 'cover';
        }
      } catch (e) {
        console.warn('applyBackgroundFromObject error', e);
      }
    }

    function applyBackgroundFromLocal() {
      try {
        const raw = localStorage.getItem('backgroundSetting');
        if (raw) {
          const bgObj = JSON.parse(raw);
          applyBackgroundFromObject(bgObj);
        } else {
          document.body.style.background = "linear-gradient(180deg,#eef6fb,#f4f6f9)";
        }
      } catch (e) {
        console.warn('applyBackgroundFromLocal error', e);
        document.body.style.background = "linear-gradient(180deg,#eef6fb,#f4f6f9)";
      }
    }

    async function saveBackgroundSetting(bgObj) {
      try {
        localStorage.setItem('backgroundSetting', JSON.stringify(bgObj));
      } catch (e) {
        console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù…Ø­Ù„ÙŠØ§', e);
      }

      if (currentUser) {
        try {
          const userRef = doc(db, 'users', currentUser.uid);
          const snap = await getDoc(userRef);
          let base = {};
          if (snap.exists()) base = snap.data();
          const settings = base.settings || {};
          settings.background = bgObj;
          await setDoc(userRef, { settings }, { merge: true });
        } catch (e) {
          console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙÙŠ Firestore', e);
        }
      }
    }

    changeBgBtn.addEventListener('click', async () => {
      const choice = prompt('Ø§ÙƒØªØ¨ "color" Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ† (Ù…Ø«Ø§Ù„: #ffffff) Ø£Ùˆ "image" Ù„ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù„Ù„Ø®Ù„ÙÙŠØ©:');
      if (!choice) return;
      if (choice === 'color') {
        const color = prompt('Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù„ÙˆÙ† (Ù…Ø«Ø§Ù„: #2c3e50 Ø£Ùˆ rgb(...) ):', '#2c3e50');
        if (!color) return;
        document.body.style.background = color;
        await saveBackgroundSetting({ type: 'color', value: color });
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù„ÙˆÙ† ÙƒØ®Ù„ÙÙŠØ©.');
      } else if (choice === 'image') {
        const url = prompt('Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø®Ù„ÙÙŠØ© (Ù…Ø«Ø§Ù„: https://example.com/bg.jpg):');
        if (!url) return;
        document.body.style.background = `url(${url}) no-repeat center center fixed`;
        document.body.style.backgroundSize = 'cover';
        await saveBackgroundSetting({ type: 'image', value: url });
        alert('ØªÙ… Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©.');
      } else {
        alert('Ø®ÙŠØ§Ø± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…ØŒ Ø§ÙƒØªØ¨ "color" Ø£Ùˆ "image".');
      }
    });

    // ----------------------------
    // UI settings: font size & opacity
    // ----------------------------
    function applyFontSize(size) {
      try {
        document.documentElement.style.setProperty('--base-font-size', (typeof size === 'number' ? size : parseInt(size)) + 'px');
        fontSizeValue.textContent = (typeof size === 'number' ? size : parseInt(size)) + 'px';
      } catch (e) {
        console.warn('applyFontSize error', e);
      }
    }

    function applyOpacity(val, applyImgs = false) {
      try {
        const opacity = parseFloat(val);
        document.documentElement.style.setProperty('--card-opacity', opacity);
        document.documentElement.style.setProperty('--panel-opacity', opacity);
        if (applyImgs) {
          document.documentElement.style.setProperty('--img-opacity', opacity);
        } else {
          document.documentElement.style.setProperty('--img-opacity', 1);
        }
        opacityValue.textContent = Math.round(opacity * 100) + '%';
        applyToImages.checked = !!applyImgs;
      } catch (e) {
        console.warn('applyOpacity error', e);
      }
    }

    async function saveUISettings(obj) {
      try {
        const cur = JSON.parse(localStorage.getItem('uiSettings') || '{}');
        const merged = Object.assign(cur, obj);
        localStorage.setItem('uiSettings', JSON.stringify(merged));
      } catch (e) {
        console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ù„ÙŠØ§Ù‹', e);
      }

      if (currentUser) {
        try {
          const userRef = doc(db, 'users', currentUser.uid);
          const snap = await getDoc(userRef);
          let base = {};
          if (snap.exists()) base = snap.data();
          const settings = base.settings || {};
          settings.ui = Object.assign(settings.ui || {}, obj);
          await setDoc(userRef, { settings }, { merge: true });
        } catch (e) {
          console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙŠ Firestore', e);
        }
      }
    }

    function applyUISettingsFromLocal() {
      try {
        const raw = localStorage.getItem('uiSettings');
        if (raw) {
          const ui = JSON.parse(raw);
          if (ui.fontSize) applyFontSize(ui.fontSize);
          if (typeof ui.opacity !== 'undefined') applyOpacity(ui.opacity, ui.applyToImages);
          syncUIControls(ui);
        } else {
          applyFontSize(14);
          applyOpacity(1, false);
          syncUIControls({ fontSize: 14, opacity: 1, applyToImages: false });
        }
      } catch (e) {
        console.warn('applyUISettingsFromLocal error', e);
        applyFontSize(14);
        applyOpacity(1, false);
      }
    }

    function syncUIControls(ui) {
      try {
        if (typeof ui.fontSize !== 'undefined') fontSizeRange.value = ui.fontSize;
        if (typeof ui.opacity !== 'undefined') opacityRange.value = ui.opacity;
        applyToImages.checked = !!ui.applyToImages;
        fontSizeValue.textContent = (ui.fontSize || 14) + 'px';
        opacityValue.textContent = Math.round((typeof ui.opacity !== 'undefined' ? ui.opacity : 1) * 100) + '%';
      } catch (e) {
        console.warn('syncUIControls error', e);
      }
    }

    fontSizeRange.addEventListener('input', e => {
      const val = parseInt(e.target.value);
      applyFontSize(val);
      saveUISettings({ fontSize: val });
    });

    opacityRange.addEventListener('input', e => {
      const val = parseFloat(e.target.value);
      const applyImgs = applyToImages.checked;
      applyOpacity(val, applyImgs);
      saveUISettings({ opacity: val, applyToImages: applyImgs });
    });

    applyToImages.addEventListener('change', () => {
      const val = parseFloat(opacityRange.value);
      applyOpacity(val, applyToImages.checked);
      saveUISettings({ opacity: val, applyToImages: applyToImages.checked });
    });

    resetViewBtn.addEventListener('click', () => {
      applyFontSize(14);
      applyOpacity(1, false);
      saveUISettings({ fontSize: 14, opacity: 1, applyToImages: false });
      alert('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.');
    });

    // ----------------------------
    // Audio player logic (Ù…Ø·ÙˆÙ‘Ù„) â€” ÙŠØ¯Ø¹Ù… ØªØ­ÙˆÙŠÙ„ Ø±ÙˆØ§Ø¨Ø· Google Drive ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    // ----------------------------
    function isGoogleDriveViewLink(url) {
      try {
        const u = new URL(url);
        return (u.hostname.includes('drive.google.com') && (u.pathname.includes('/file/d/') || u.pathname.includes('/open')));
      } catch (e) {
        return false;
      }
    }

    function driveViewToDirect(url) {
      try {
        const u = new URL(url);
        const m = u.pathname.match(/\/d\/(.*?)\//);
        if (m && m[1]) return `https://docs.google.com/uc?export=download&id=${m[1]}`;
        if (u.searchParams.get('id')) return `https://docs.google.com/uc?export=download&id=${u.searchParams.get('id')}`;
        return url;
      } catch (e) {
        return url;
      }
    }

    function renderPlaylist() {
      playlistEl.innerHTML = '';
      tracks.forEach((t, idx) => {
        const li = document.createElement('li');

        const left = document.createElement('div');
        left.style.flex = '1';
        left.style.display = 'flex';
        left.style.flexDirection = 'column';

        const title = document.createElement('div');
        title.textContent = t.name || `Ù…Ù„Ù ${idx + 1}`;
        title.style.cursor = 'pointer';
        title.onclick = () => { currentIndex = idx; loadTrack(currentIndex); };

        const urlDiv = document.createElement('div');
        urlDiv.textContent = t.url;
        urlDiv.style.fontSize = '12px';
        urlDiv.style.color = 'var(--muted)';
        urlDiv.style.wordBreak = 'break-all';

        left.appendChild(title);
        left.appendChild(urlDiv);

        const actions = document.createElement('div');

        const del = document.createElement('button');
        del.textContent = 'Ø­Ø°Ù';
        del.onclick = () => {
          tracks.splice(idx, 1);
          savePlaylistLocal();
          renderPlaylist();
          if (currentIndex >= tracks.length) currentIndex = Math.max(0, tracks.length - 1);
          if (tracks.length > 0) loadTrack(currentIndex);
          else { audio.pause(); audio.src = ''; trackNameEl.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø´ØºÙ„'; }
        };

        const edit = document.createElement('button');
        edit.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù…';
        edit.onclick = () => {
          const newName = prompt('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯', t.name || `Ù…Ù„Ù ${idx + 1}`);
          if (newName !== null) { tracks[idx].name = newName; renderPlaylist(); savePlaylistLocal(); }
        };

        actions.appendChild(edit);
        actions.appendChild(del);

        li.appendChild(left);
        li.appendChild(actions);

        playlistEl.appendChild(li);
      });

      highlightPlaying();
    }

    function loadTrack(index) {
      if (!tracks || tracks.length === 0) return;
      currentIndex = index;
      let url = tracks[index].url;
      if (isGoogleDriveViewLink(url)) url = driveViewToDirect(url);
      audio.src = url;
      trackNameEl.textContent = tracks[index].name || `Ù…Ù„Ù ${index + 1}`;
      audio.play().catch(() => { /* ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ */ });
      highlightPlaying();
    }

    function nextTrack() {
      if (tracks.length === 0) return;
      currentIndex = (currentIndex + 1) % tracks.length;
      loadTrack(currentIndex);
    }

    function prevTrack() {
      if (tracks.length === 0) return;
      currentIndex = (currentIndex - 1 + tracks.length) % tracks.length;
      loadTrack(currentIndex);
    }

    addTrackBtn.addEventListener('click', async () => {
      const url = (newTrackUrl.value || '').trim();
      let name = (newTrackName.value || '').trim();
      if (!url) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØª Ø£ÙˆÙ„Ø§Ù‹'); return; }
      let finalUrl = url;
      if (isGoogleDriveViewLink(url)) finalUrl = driveViewToDirect(url);
      if (!name) name = finalUrl.split('/').pop().substring(0, 40) || `Ù…Ù„Ù ${tracks.length + 1}`;
      tracks.push({ name, url });
      newTrackUrl.value = '';
      newTrackName.value = '';
      renderPlaylist();
      savePlaylistLocal();
      if (tracks.length === 1) loadTrack(0);
    });

    prevBtn.addEventListener('click', prevTrack);
    nextBtn.addEventListener('click', nextTrack);

    audio.addEventListener('ended', () => { nextTrack(); });

    function highlightPlaying() {
      const items = playlistEl.querySelectorAll('li');
      items.forEach((li, i) => { li.style.background = i === currentIndex ? 'rgba(41,128,185,0.06)' : 'transparent'; });
    }

    // ----------------------------
    // Save/load playlist to Firestore and localStorage
    // ----------------------------
    async function savePlaylistToFirestore() {
      if (!currentUser) { alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ'); return; }
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        const snap = await getDoc(userRef);
        let base = {};
        if (snap.exists()) base = snap.data();
        const settings = base.settings || {};
        settings.playlist = tracks.slice();
        await setDoc(userRef, { settings }, { merge: true });
        savePlaylistLocal();
        alert('ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ');
      } catch (e) {
        console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Firestore', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
      }
    }

    function savePlaylistLocal() {
      try {
        localStorage.setItem('playlist', JSON.stringify(tracks));
      } catch (e) {
        console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ù„ÙŠØ§Ù‹', e);
      }
    }

    function loadPlaylistFromLocal() {
      try {
        const raw = localStorage.getItem('playlist');
        if (raw) {
          tracks = JSON.parse(raw);
          renderPlaylist();
          if (tracks.length > 0) loadTrack(0);
        }
      } catch (e) {
        console.warn('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©', e);
      }
    }

    savePlaylistBtn.addEventListener('click', savePlaylistToFirestore);

    clearPlaylistBtn.addEventListener('click', () => {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ØŸ')) return;
      tracks = [];
      renderPlaylist();
      savePlaylistLocal();
      if (currentUser) { savePlaylistToFirestore().catch(() => {}); }
      audio.pause();
      audio.src = '';
      trackNameEl.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø´ØºÙ„';
    });

    // ----------------------------
    // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬
    // ----------------------------
    window.addEventListener('beforeunload', async () => {
      try {
        savePlaylistLocal();
        if (currentUser) {
          const userRef = doc(db, 'users', currentUser.uid);
          const panels = {
            listPanel: { left: listPanel.style.left || listPanel.offsetLeft + 'px', top: listPanel.style.top || listPanel.offsetTop + 'px', width: listPanel.style.width || listPanel.offsetWidth + 'px', height: listPanel.style.height || listPanel.offsetHeight + 'px' },
            chatPanel: { left: chatPanel.style.left || chatPanel.offsetLeft + 'px', top: chatPanel.style.top || chatPanel.offsetTop + 'px', width: chatPanel.style.width || chatPanel.offsetWidth + 'px', height: chatPanel.style.height || chatPanel.offsetHeight + 'px' }
          };
          await setDoc(userRef, { panels }, { merge: true });

          try {
            const uiRaw = JSON.parse(localStorage.getItem('uiSettings') || '{}');
            const settingsSnap = await getDoc(userRef);
            let base = {};
            if (settingsSnap.exists()) base = settingsSnap.data();
            const settings = base.settings || {};
            settings.ui = Object.assign(settings.ui || {}, uiRaw);
            settings.playlist = tracks.slice();
            await setDoc(userRef, { settings }, { merge: true });
          } catch (e) {
            console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬', e);
          }
        }
      } catch (e) {
        console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬', e);
      }
    });

    // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.addEventListener('load', () => {
      applyBackgroundFromLocal();
      applyUISettingsFromLocal();
      loadPlaylistFromLocal();
    });

  </script>

</body>
</html>
