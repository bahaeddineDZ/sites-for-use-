<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸ“š Ù…ÙƒØªØ¨ØªÙŠ Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ - Baha - </title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --primary:#2c3e50;
  --accent:#2980b9;
  --danger:#e74c3c;
  --muted:#7f8c8d;
  --card:#ffffff;
}
*{box-sizing:border-box;}
body{font-family:Tahoma, Arial, sans-serif;margin:0;padding:0;min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(180deg,#eef6fb,#f4f6f9);}
header{background:var(--primary);color:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center;justify-content:space-between;}
header h1{margin:0;font-size:18px;}
.user-area{display:flex;align-items:center;gap:10px;}
.user-pic{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.2);}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid rgba(0,0,0,0.06);}
.layout{display:flex;gap:18px;padding:18px;flex:1;align-items:flex-start;position:relative;}
.board{flex:1;min-width:320px;position:relative;}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
.controls input{padding:10px;border-radius:10px;border:1px solid #d0d7de;font-size:14px;flex:1;min-width:140px;}
.controls .add-btn{background:var(--accent);padding:10px 16px;border-radius:10px;color:#fff;border:none;cursor:pointer;}
.controls .bg-btn{background:#2ecc71;color:#fff;padding:10px 16px;border-radius:10px;border:none;cursor:pointer;}
#siteList{position:relative;min-height:420px;border-radius:12px;padding:12px;background:transparent;}
.card{position:absolute;width:200px;height:250px;border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,0.12);overflow:hidden;background:var(--card);transition:transform .15s;}
.card:hover{transform:translateY(-6px);}
.card img{width:100%;height:100%;object-fit:cover;display:block;cursor:pointer;}
.card-content{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);color:#fff;padding:8px;text-align:center;}
.card-content h3{margin:0;font-size:14px;}
.card .drag-handle{position:absolute;top:6px;right:6px;width:22px;height:22px;background:var(--accent);border-radius:6px;cursor:move;z-index:20}
.card .resize-handle{position:absolute;left:6px;bottom:6px;width:16px;height:16px;background:#2ecc71;clip-path:polygon(0 100%,100% 100%,0 0);cursor:nwse-resize;z-index:20}
.card .actions button{margin:2px;padding:6px 8px;border-radius:8px;border:none;cursor:pointer;}
.card .actions .delete{background:var(--danger);color:#fff;}
.card .actions .edit{background:#f39c12;color:#fff;}
.side{width:360px;max-width:40vw;display:flex;flex-direction:column;gap:12px;}
.list-panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.06);min-height:180px;position:absolute;left:20px;top:20px;width:300px;height:200px;z-index:30;}
.list-panel h3{margin:0 0 8px 0;font-size:16px;color:var(--primary);}
.sites-list-short{display:flex;flex-direction:column;gap:8px;max-height:160px;overflow:auto;}
.site-item{display:flex;gap:8px;align-items:center;}
.site-item img{width:48px;height:36px;object-fit:cover;border-radius:6px;}
.site-item a{color:var(--accent);text-decoration:none;display:block;}
.chat-panel{display:flex;flex-direction:column;gap:8px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.06);position:absolute;right:20px;top:240px;width:360px;height:420px;z-index:28;}
.chat-panel h3{margin:0 0 4px 0;font-size:16px;color:var(--primary);}
#chatBox{overflow:auto;border-radius:8px;padding:8px;background:#fbfdff;border:1px solid #eef5fb;}
.msg{display:inline-block;padding:8px 12px;margin:5px 0;border-radius:15px;max-width:70%;clear:both;word-wrap:break-word;}
.chat-controls{display:flex;gap:5px;margin-top:6px;position:relative;}
.chat-controls input{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;}
.chat-controls button{padding:8px 12px;border:none;border-radius:6px;background:#2980b9;color:white;cursor:pointer;}
.chat-controls button:hover{background:#1f5f87;}
.emoji-panel{display:none;background:white;border:1px solid #ccc;border-radius:10px;padding:10px;max-height:120px;overflow-y:auto;position:absolute;bottom:60px;right:10px;z-index:1000;box-shadow:0 6px 12px rgba(0,0,0,0.15);transition:all 0.2s ease;}
.emoji-panel span{cursor:pointer;font-size:20px;margin:5px;}
#chatHint{margin-top:8px;font-size:12px;color:gray;text-align:center;}
/* Ù…Ù‚Ø§Ø¨Ø¶ Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ÙˆØ­/Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
.panel-drag-handle{position:absolute;top:8px;right:8px;width:26px;height:26px;background:var(--accent);border-radius:8px;cursor:move;z-index:40;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px}
.panel-resize-handle{position:absolute;left:8px;bottom:8px;width:18px;height:18px;background:#2ecc71;clip-path:polygon(0 100%,100% 100%,0 0);cursor:nwse-resize;z-index:40}
/* ØªÙˆØ³ÙŠØ¹ Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„ÙƒÙŠ ØªØªØºÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ø±Ù† */
.list-panel .resize-handle,.list-panel .drag-handle{z-index:35}
.chat-panel .resize-handle,.chat-panel .drag-handle{z-index:35}
/* Ø¬Ø¹Ù„ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ø±Ù†Ø© ÙˆØ¨Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„ØªÙ…Ø¯Ø¯ */
.list-panel .sites-list-short{max-height:calc(100% - 56px)}
.chat-panel #chatBox{height:calc(100% - 120px);min-height:80px}
.footer-space{height:12px}
footer{padding:10px;text-align:center;color:var(--muted);font-size:13px;}
@media(max-width:900px){.layout{flex-direction:column}.side{width:100%;}}
</style>
</head>
<body>

<header>
<h1>ğŸ“š Ù…ÙƒØªØ¨ØªÙŠ Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ - Baha -</h1>
<div class="user-area" id="userArea">
<img id="userPic" class="user-pic" src="" alt="" style="display:none">
<div id="userName" class="small" style="display:none"></div>
<button id="loginBtn" class="btn">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
<button id="logoutBtn" class="btn secondary" style="display:none">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>
</header>

<div class="layout">
<div class="board">
<div class="controls">
<input id="siteName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹">
<input id="siteUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (https://)">
<input id="siteImage" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
<button id="addBtn" class="add-btn">â• Ø¥Ø¶Ø§ÙØ©</button>
<button id="changeBgBtn" class="bg-btn">ğŸ¨ ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
</div>
<div id="siteList" aria-live="polite"></div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ â€” Ø£ØµØ¨Ø­Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„ØªØºÙŠÙŠØ± ÙƒÙ…Ø§ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
<div class="list-panel" id="listPanel" style="position:absolute; left:20px; top:20px; width:300px; height:200px;">
  <div class="drag-handle" title="Ø§Ø³Ø­Ø¨" aria-hidden="true">â˜°</div>
  <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</h3>
  <div class="sites-list-short" id="sitesShort"></div>
  <div class="resize-handle" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…" aria-hidden="true"></div>
</div>


<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© â€” Ø£ØµØ¨Ø­Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… -->
<div class="chat-panel" id="chatPanel" style="position:absolute; right:20px; top:240px; width:360px; height:420px;">
  <div class="drag-handle" title="Ø§Ø³Ø­Ø¨" aria-hidden="true">â˜°</div>
  <h3>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­ÙŠØ©</h3>
  <div id="chatBox"></div>
  <div class="chat-controls">
    <input id="chatMessage" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." />
    <button type="button" onclick="toggleEmojiPanel()">ğŸ˜Š</button>
    <button id="sendMsgBtn">ğŸ“¨</button>
  </div>
  <div id="emojiPanel" class="emoji-panel"></div>
  <div id="chatHint" class="small">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©.</div>
  <div class="resize-handle" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…" aria-hidden="true"></div>
</div>

</div>

<footer>Â© Ù…ÙƒØªØ¨ØªÙŠ Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ â€” BBE</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
apiKey: "AIzaSyAMJkL6Fvv9kzgWtHz7ccp79H80EhLogqk",
authDomain: "site-for-use.firebaseapp.com",
projectId: "site-for-use",
storageBucket: "site-for-use.appspot.com",
messagingSenderId: "44820921915",
appId: "1:44820921915:web:27ff432c93b013e7a2a61e",
measurementId: "G-LRLK1DGEX7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const addBtn=document.getElementById("addBtn");
const siteList=document.getElementById("siteList");
const sitesShort=document.getElementById("sitesShort");
const siteNameInput=document.getElementById("siteName");
const siteUrlInput=document.getElementById("siteUrl");
const siteImageInput=document.getElementById("siteImage");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const userPic=document.getElementById("userPic");
const userNameEl=document.getElementById("userName");
const chatBox=document.getElementById("chatBox");
const chatInput=document.getElementById("chatMessage");
const sendMsgBtn=document.getElementById("sendMsgBtn");
const chatHint=document.getElementById("chatHint");
const emojiPanel = document.getElementById("emojiPanel");
const changeBgBtn = document.getElementById("changeBgBtn");
const listPanel = document.getElementById('listPanel');
const chatPanel = document.getElementById('chatPanel');

let currentUser=null;
let editId=null;

// Authentication
loginBtn.addEventListener("click",async()=>{try{await signInWithPopup(auth,provider);}catch(e){alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: "+e.message);}});
logoutBtn.addEventListener("click",async()=>{await signOut(auth);});
onAuthStateChanged(auth,user=>{
currentUser=user||null;
loginBtn.style.display=user?"none":"inline-block";
logoutBtn.style.display=user?"inline-block":"none";
userPic.src=user?.photoURL||"";
userPic.style.display=user?.photoURL?"inline-block":"none";
userNameEl.textContent=user?.displayName||user?.email||"Ù…Ø³ØªØ®Ø¯Ù…";
userNameEl.style.display=user?"inline-block":"none";
chatHint.textContent=user?"Ù…Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹.":"Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©.";
});

// Sites handling
const sitesCol=collection(db,"sites");
onSnapshot(sitesCol,snapshot=>{
siteList.innerHTML=""; sitesShort.innerHTML="";
snapshot.forEach(docSnap=>{
const site=docSnap.data(); const id=docSnap.id;
const card=document.createElement("div"); card.className="card";
card.style.left=site.left||"0px"; card.style.top=site.top||"0px";
card.style.width=site.width||"200px"; card.style.height=site.height||"250px";
const img=document.createElement("img"); img.src=site.image||"https://via.placeholder.com/200x250";
img.onclick=()=>window.open(site.url,"_blank");
const content=document.createElement("div"); content.className="card-content";
const title=document.createElement("h3"); title.textContent=site.name;
const actions=document.createElement("div"); actions.className="actions";
const editBtn=document.createElement("button"); editBtn.className="edit"; editBtn.textContent="âœï¸ ØªØ¹Ø¯ÙŠÙ„"; editBtn.onclick=()=>openEdit(id);
const deleteBtn=document.createElement("button"); deleteBtn.className="delete"; deleteBtn.textContent="ğŸ—‘ Ø­Ø°Ù"; deleteBtn.onclick=()=>deleteSite(id);
actions.appendChild(editBtn); actions.appendChild(deleteBtn);
content.appendChild(title); content.appendChild(actions);
const dragHandle=document.createElement("div"); dragHandle.className="drag-handle";
const resizeHandle=document.createElement("div"); resizeHandle.className="resize-handle";
card.appendChild(img); card.appendChild(content); card.appendChild(dragHandle); card.appendChild(resizeHandle);
enableDragResize(card,id); siteList.appendChild(card);

const short=document.createElement("div"); short.className="site-item";
short.innerHTML=`<img src="${site.image||'https://via.placeholder.com/48x36'}"><a href="${site.url}" target="_blank">${site.name}</a>`;
sitesShort.appendChild(short);
});
});

// Add/Edit site
addBtn.addEventListener("click",async()=>{
if(!currentUser){alert("Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");return;}
const name=siteNameInput.value.trim(); const url=siteUrlInput.value.trim();
if(!name||!url){alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ø§Ø¨Ø·");return;}
const image=siteImageInput.value.trim()||"";
if(editId){
await updateDoc(doc(db,"sites",editId),{name,url,image});
editId=null; addBtn.textContent="â• Ø¥Ø¶Ø§ÙØ©";
}else{
await addDoc(sitesCol,{name,url,image,left:"0px",top:"0px",width:"200px",height:"250px"});
}
siteNameInput.value=""; siteUrlInput.value=""; siteImageInput.value="";
});

function openEdit(id){editId=id; getDoc(doc(db,"sites",id)).then(snap=>{const data=snap.data(); siteNameInput.value=data.name; siteUrlInput.value=data.url; siteImageInput.value=data.image||""; addBtn.textContent="ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";});}
function deleteSite(id){if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŸ")) deleteDoc(doc(db,"sites",id));}

// Drag & Resize for site cards (existing functionality) â€” Ù„Ø§ Ù†ØºÙŠØ±Ù‡Ø§
function enableDragResize(card,id){
let offsetX=0,offsetY=0,isDragging=false;
let startWidth=0,startHeight=0,isResizing=false;

const dragHandle=card.querySelector(".drag-handle");
const resizeHandle=card.querySelector(".resize-handle");

dragHandle.addEventListener("mousedown",e=>{
isDragging=true;
offsetX=e.clientX-card.offsetLeft;
offsetY=e.clientY-card.offsetTop;
document.body.style.userSelect="none";
});
resizeHandle.addEventListener("mousedown",e=>{
isResizing=true;
startWidth=card.offsetWidth; startHeight=card.offsetHeight;
offsetX=e.clientX; offsetY=e.clientY;
document.body.style.userSelect="none";
});
document.addEventListener("mousemove",e=>{
if(isDragging){card.style.left=e.clientX-offsetX+"px"; card.style.top=e.clientY-offsetY+"px";}
if(isResizing){card.style.width=Math.max(100,startWidth+(e.clientX-offsetX))+"px"; card.style.height=Math.max(120,startHeight+(e.clientY-offsetY))+"px";}
});
document.addEventListener("mouseup",async()=>{
if(isDragging||isResizing){
await updateDoc(doc(db,"sites",id),{left:card.style.left,top:card.style.top,width:card.style.width,height:card.style.height});
isDragging=false; isResizing=false; document.body.style.userSelect="auto";
}
});
}

// ÙˆØ¸ÙŠÙØ© Ø¹Ø§Ù…Ø© Ù„Ø¬Ø¹Ù„ Ø£ÙŠ Ù„ÙˆØ­Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨ ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆÙ†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©)
function enablePanelDragResize(panel, storageKey){
// panel: Ø¹Ù†ØµØ± DOM (div) ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± .drag-handle Ùˆ .resize-handle Ø¯Ø§Ø®Ù„Ù‡
let startX=0, startY=0, startLeft=0, startTop=0, startWidth=0, startHeight=0;
let isDragging=false, isResizing=false;
const dragHandle = panel.querySelector('.drag-handle');
const resizeHandle = panel.querySelector('.resize-handle');

// Touch/mouse compatibility (Ø£Ø³Ø§Ø³ÙŠ)
dragHandle.addEventListener('mousedown', e=>{
isDragging = true;
startX = e.clientX; startY = e.clientY;
// Ø­ÙØ¸ Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…Ø¹Ø±Ù‘ÙØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù‚ÙŠÙ… offset)
startLeft = parseInt(panel.style.left || panel.offsetLeft);
startTop = parseInt(panel.style.top || panel.offsetTop);
document.body.style.userSelect = 'none';
});

resizeHandle.addEventListener('mousedown', e=>{
isResizing = true;
startX = e.clientX; startY = e.clientY;
startWidth = panel.offsetWidth; startHeight = panel.offsetHeight;
document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', e=>{
if(isDragging){
const dx = e.clientX - startX; const dy = e.clientY - startY;
panel.style.left = (startLeft + dx) + 'px';
panel.style.top = (startTop + dy) + 'px';
}
if(isResizing){
const dx = e.clientX - startX; const dy = e.clientY - startY;
panel.style.width = Math.max(180, startWidth + dx) + 'px';
panel.style.height = Math.max(140, startHeight + dy) + 'px';
// ØªØ¹Ø¯ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„ÙˆØ­Ø© Ù‡ÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
if(panel.id === 'chatPanel'){
chatBox.style.height = (panel.clientHeight - 120) + 'px';
}
}
});

document.addEventListener('mouseup', ()=>{
if(isDragging || isResizing){
// Ø­ÙØ¸ Ø§Ù„ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ù„Ø§ Ù†ØªØ¯Ø®Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ù„Ø§ Ù†ØºÙŠØ± ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹)
savePanelState(storageKey, panel);
}
isDragging = false; isResizing = false; document.body.style.userSelect = 'auto';
});
}

function savePanelState(key, panel){
try{
const data = JSON.parse(localStorage.getItem('panelPositions') || '{}');
data[key] = {left: panel.style.left || panel.offsetLeft + 'px', top: panel.style.top || panel.offsetTop + 'px', width: panel.style.width || panel.offsetWidth + 'px', height: panel.style.height || panel.offsetHeight + 'px'};
localStorage.setItem('panelPositions', JSON.stringify(data));
}catch(e){console.warn('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§', e);} 
}

function applySavedPanels(){
try{
const data = JSON.parse(localStorage.getItem('panelPositions') || '{}');
if(data.listPanel){
listPanel.style.position = 'absolute';
listPanel.style.left = data.listPanel.left; listPanel.style.top = data.listPanel.top; listPanel.style.width = data.listPanel.width; listPanel.style.height = data.listPanel.height;
}
if(data.chatPanel){
chatPanel.style.position = 'absolute';
chatPanel.style.left = data.chatPanel.left || chatPanel.style.left; chatPanel.style.top = data.chatPanel.top || chatPanel.style.top; // n.b. for RTL we may prefer right, but left works consistently with saved value
chatPanel.style.width = data.chatPanel.width; chatPanel.style.height = data.chatPanel.height;
// ØªØ­Ø¯ÙŠØ« ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§ Ù„ÙŠØªÙ†Ø§Ø³Ø¨
chatBox.style.height = (chatPanel.clientHeight - 120) + 'px';
}
}catch(e){console.warn('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ', e);} 
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª) Ù‚Ø¨Ù„ ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ø­Ø¨
applySavedPanels();

// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„ØªØºÙŠÙŠØ± Ù„ÙƒÙ„ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙ†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
enablePanelDragResize(listPanel, 'listPanel');
enablePanelDragResize(chatPanel, 'chatPanel');

// Firestore reference Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const usersCol = collection(db, "users");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async user => {
    currentUser = user || null;
    loginBtn.style.display = user ? "none" : "inline-block";
    logoutBtn.style.display = user ? "inline-block" : "none";
    userPic.src = user?.photoURL || "";
    userPic.style.display = user?.photoURL ? "inline-block" : "none";
    userNameEl.textContent = user?.displayName || user?.email || "Ù…Ø³ØªØ®Ø¯Ù…";
    userNameEl.style.display = user ? "inline-block" : "none";
    chatHint.textContent = user ? "Ù…Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹." : "Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©.";

    if(user){
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if(userDoc.exists()){
            const data = userDoc.data();
            if(data.bgUrl){
                document.body.style.background = `url(${data.bgUrl}) no-repeat center center fixed`;
                document.body.style.backgroundSize = "cover";
            }
        }
    } else {
        document.body.style.background = "linear-gradient(180deg,#eef6fb,#f4f6f9)";
    }
});

// Chat
const chatCol=collection(db,"chat");
onSnapshot(query(chatCol,orderBy("timestamp")),snapshot=>{
chatBox.innerHTML="";
snapshot.forEach(docSnap=>{
const msg=docSnap.data(); 
const div=document.createElement("div"); div.className="msg "+(msg.uid===currentUser?.uid?"me":"other");
const userInfo = document.createElement("div"); userInfo.style.display="flex"; userInfo.style.alignItems="center"; userInfo.style.gap = "6px"; userInfo.style.marginBottom = "2px";
const img = document.createElement("img"); img.src = msg.photoURL || "https://via.placeholder.com/24"; img.style.width="24px"; img.style.height="24px"; img.style.borderRadius="50%"; img.style.objectFit="cover";
const name = document.createElement("span"); name.textContent = msg.displayName || "Ù…Ø³ØªØ®Ø¯Ù…"; name.style.fontSize="12px"; name.style.color = msg.uid===currentUser?.uid?"#fff":"#555";
userInfo.appendChild(img); userInfo.appendChild(name);
const textDiv = document.createElement("div"); textDiv.textContent = msg.text;
div.innerHTML = ""; div.appendChild(userInfo); div.appendChild(textDiv);
div.style.maxWidth="70%"; div.style.marginBottom="6px"; div.style.clear="both"; div.style.padding="6px 10px"; div.style.borderRadius="12px"; div.style.wordWrap="break-word";
div.style.background = msg.uid===currentUser?.uid?"#2980b9":"#e0e0e0"; div.style.color = msg.uid===currentUser?.uid?"#fff":"#000";
div.style.float = msg.uid===currentUser?.uid?"right":"left";
chatBox.appendChild(div); chatBox.scrollTop=chatBox.scrollHeight;
});
});

sendMsgBtn.addEventListener("click",sendMsg);
chatInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendMsg();});
function sendMsg(){if(!currentUser){alert("Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return;}
const text=chatInput.value.trim(); if(!text) return;
addDoc(chatCol,{text,uid:currentUser.uid,displayName: currentUser.displayName,photoURL: currentUser.photoURL,timestamp: serverTimestamp()});
chatInput.value="";
}

// Emoji
function toggleEmojiPanel() {
if(emojiPanel.style.display==="block"){emojiPanel.style.display="none";} 
else{
emojiPanel.style.display="block";
if (!emojiPanel.hasChildNodes()) {
const emojis = "ğŸ˜€ ğŸ˜ƒ ğŸ˜„ ğŸ˜ ğŸ˜† ğŸ˜… ğŸ˜‚ ğŸ¤£ ğŸ˜Š ğŸ˜‡ ğŸ™‚ ğŸ™ƒ ğŸ˜‰ ğŸ˜Œ ğŸ˜ ğŸ¥° ğŸ˜˜ ğŸ˜— ğŸ˜™ ğŸ˜š ğŸ˜‹ ğŸ˜› ğŸ˜œ ğŸ¤ª ğŸ˜ ğŸ¤‘ ğŸ¤— ğŸ¤­ ğŸ¤« ğŸ¤” ğŸ¤ ğŸ¤¨ ğŸ˜ ğŸ˜‘ ğŸ˜¶ ğŸ˜".split(" ");
emojis.forEach(e => {const span = document.createElement("span"); span.textContent = e; span.onclick=()=>{chatInput.value+=e; emojiPanel.style.display="none";}; emojiPanel.appendChild(span);});
}
}
}

// Change background
changeBgBtn.addEventListener("click", async () => {
    if(!currentUser){ alert("Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }
    const url = prompt("Ø¶Ø¹ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù„Ù„Ø®Ù„ÙÙŠØ©:");
    if(url){
        document.body.style.background = `url(${url}) no-repeat center center fixed`;
        document.body.style.backgroundSize = "cover";
        // Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Firestore ØªØ­Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        await updateDoc(doc(db, "users", currentUser.uid), { bgUrl: url }).catch(async()=>{
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¥Ù†Ø´Ø¦Ù‡
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙƒØ§Ù† ÙŠØ­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… setDocØŒ Ù„ÙƒÙ† Ù„ØªØ¬Ù†Ù‘Ø¨ Ø£ÙŠ ØªØºÙŠÙŠØ± Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†ØªØ±Ùƒ Ù‡Ø°Ø§ ÙƒÙ…Ø§ Ù‡Ùˆ
            await updateDoc(doc(db, "users", currentUser.uid), { bgUrl: url }).catch(()=>{});
        });
    }
});

// Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„: Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙˆØ­Ø©
window.addEventListener('load', ()=>{
try{ chatBox.style.height = (chatPanel.clientHeight - 120) + 'px'; }catch(e){}
});

// Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø§Øª Ù‚Ø¨Ù„ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
window.addEventListener('beforeunload', ()=>{ try{ savePanelState('listPanel', listPanel); savePanelState('chatPanel', chatPanel); }catch(e){} });

</script>
</body>
</html>
